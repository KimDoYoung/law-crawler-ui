{% extends "common/base.html" %}

{% block style %}
<style>
  .metric-card {
    @apply bg-white border border-gray-200 rounded-lg p-4 shadow-sm;
  }

  .metric-value {
    @apply text-2xl font-bold text-gray-800;
  }

  .metric-label {
    @apply text-sm text-gray-600 mt-2;
  }

  .metric-delta {
    @apply text-xs text-green-600 mt-1;
  }
</style>
{% endblock %}

{% block content %}
<div x-data="dashboardData()">
  <!-- í˜ì´ì§€ ì œëª© -->
  <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“Š ëŒ€ì‹œë³´ë“œ</h1>
  <p class="text-gray-600 mb-6">ë²•ê·œê´€ë ¨ ë°ì´í„°ìˆ˜ì§‘ í˜„í™©</p>

  <!-- ì£¼ìš” ì§€í‘œ (ë©”íŠ¸ë¦­ ì¹´ë“œ) -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-8">
    <!-- ìˆ˜ì§‘ ì‚¬ì´íŠ¸ -->
    <div class="metric-card">
      <div class="metric-label">ìˆ˜ì§‘ ì‚¬ì´íŠ¸(pages)</div>
      <div class="metric-value" x-text="data.site_count || '-'"></div>
      <div class="metric-delta">âœ“ ì •ìƒ</div>
    </div>

    <!-- ì˜¤ëŠ˜ ìˆ˜ì§‘ -->
    <div class="metric-card">
      <div class="metric-label">ì˜¤ëŠ˜ ìˆ˜ì§‘ (ì²¨ë¶€íŒŒì¼)</div>
      <div class="metric-value" x-text="data.today_collect || '-'"></div>
    </div>

    <!-- 3ì¼ ì „ -->
    <div class="metric-card">
      <div class="metric-label">3ì¼ ì „ (ì²¨ë¶€íŒŒì¼)</div>
      <div class="metric-value" x-text="data.three_days_collect || '-'"></div>
    </div>

    <!-- 7ì¼ ì „ -->
    <div class="metric-card">
      <div class="metric-label">7ì¼ ì „ (ì²¨ë¶€íŒŒì¼)</div>
      <div class="metric-value" x-text="data.seven_days_collect || '-'"></div>
    </div>

    <!-- ì „ì²´ -->
    <div class="metric-card">
      <div class="metric-label">ì „ì²´ (ì²¨ë¶€íŒŒì¼)</div>
      <div class="metric-value" x-text="data.total_collect || '-'"></div>
    </div>

    <!-- ì˜¤ë¥˜ ë°œìƒ -->
    <div class="metric-card">
      <div class="metric-label">ì˜¤ë¥˜ ë°œìƒ</div>
      <div class="metric-value text-red-600" x-text="data.error_count || '0'"></div>
      <div class="metric-delta text-red-600">ìµœê·¼ ìˆ˜ì§‘ì‹œ</div>
    </div>
  </div>

  <hr class="my-6">

  <!-- ìˆ˜ì§‘ëœ ë°ì´í„° ì¡°íšŒ -->
  <div class="bg-white rounded-lg shadow-sm p-6">
    <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“‹ ìˆ˜ì§‘ëœ ë°ì´í„° ì¡°íšŒ</h2>

    <!-- ê¸°ê°„ ì„ íƒ ë²„íŠ¼ -->
    <div class="flex gap-2 mb-6">
      <button
        @click="selectedPeriod = 'today'; loadData('today')"
        :class="selectedPeriod === 'today' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
        class="px-4 py-2 rounded-lg font-semibold transition-colors"
      >
        ì˜¤ëŠ˜
      </button>
      <button
        @click="selectedPeriod = '3days'; loadData('3days')"
        :class="selectedPeriod === '3days' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
        class="px-4 py-2 rounded-lg font-semibold transition-colors"
      >
        3ì¼
      </button>
      <button
        @click="selectedPeriod = '7days'; loadData('7days')"
        :class="selectedPeriod === '7days' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
        class="px-4 py-2 rounded-lg font-semibold transition-colors"
      >
        7ì¼
      </button>
    </div>

    <!-- ë°ì´í„° í…Œì´ë¸” ë¡œë”© ì¤‘ -->
    <div x-show="isLoading" class="text-center py-8">
      <i class="bi bi-hourglass text-2xl text-blue-500"></i>
      <p class="text-gray-600 mt-2">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <!-- ë°ì´í„° í…Œì´ë¸” -->
    <div x-show="!isLoading" class="overflow-x-auto">
      <table class="w-full border-collapse text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="border border-gray-300 px-4 py-2 text-left">ì‚¬ì´íŠ¸</th>
            <th class="border border-gray-300 px-4 py-2 text-left">í˜ì´ì§€</th>
            <th class="border border-gray-300 px-4 py-2 text-left">ì œëª©</th>
            <th class="border border-gray-300 px-4 py-2 text-left">ë“±ë¡ì¼</th>
            <th class="border border-gray-300 px-4 py-2 text-left">ìˆ˜ì§‘ì¼ì‹œ</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="row in tableData" :key="row.page_id">
            <tr class="border-b border-gray-200 hover:bg-blue-50 cursor-pointer" @click="selectRow(row)">
              <td class="border border-gray-300 px-4 py-2">
                <a :href="row.site_url" target="_blank" class="text-blue-500 hover:underline">
                  <span x-text="row.site_name"></span>
                </a>
              </td>
              <td class="border border-gray-300 px-4 py-2">
                <a :href="row.detail_url" target="_blank" class="text-blue-500 hover:underline">
                  <span x-text="row.page_id"></span>
                </a>
              </td>
              <td class="border border-gray-300 px-4 py-2 max-w-xs truncate">
                <a :href="row.org_url" target="_blank" class="text-blue-500 hover:underline">
                  <span x-text="row.title"></span>
                </a>
              </td>
              <td class="border border-gray-300 px-4 py-2">
                <span x-text="row.registration_date || '-'"></span>
              </td>
              <td class="border border-gray-300 px-4 py-2">
                <span x-text="row.collection_date"></span>
              </td>
            </tr>
          </template>
        </tbody>
      </table>

      <!-- ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° -->
      <div x-show="tableData.length === 0" class="text-center py-8 text-gray-500">
        <p>ì¡°íšŒ ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  </div>

  <!-- ìƒì„¸ ì •ë³´ (í–‰ ì„ íƒ ì‹œ) -->
  <div x-show="selectedRow" class="bg-white rounded-lg shadow-sm p-6 mt-6">
    <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“„ ìƒì„¸ ì •ë³´</h2>

    <div x-show="selectedRow" class="space-y-3">
      <div>
        <strong class="text-gray-700">ì‚¬ì´íŠ¸:</strong>
        <a :href="selectedRow.site_url" target="_blank" class="text-blue-500 hover:underline ml-2">
          <span x-text="selectedRow.site_name"></span>
        </a>
      </div>
      <div>
        <strong class="text-gray-700">í˜ì´ì§€:</strong>
        <a :href="selectedRow.detail_url" target="_blank" class="text-blue-500 hover:underline ml-2">
          <span x-text="selectedRow.page_id"></span>
        </a>
      </div>
      <div>
        <strong class="text-gray-700">ì œëª©:</strong>
        <a :href="selectedRow.org_url" target="_blank" class="text-blue-500 hover:underline ml-2">
          <span x-text="selectedRow.title"></span>
        </a>
      </div>
      <div>
        <strong class="text-gray-700">ë“±ë¡ì¼:</strong>
        <span class="ml-2" x-text="selectedRow.registration_date || '-'"></span>
      </div>
      <div>
        <strong class="text-gray-700">ìˆ˜ì§‘ì¼ì‹œ:</strong>
        <span class="ml-2" x-text="selectedRow.collection_date"></span>
      </div>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="mt-6 border-b border-gray-200">
      <div class="flex gap-4">
        <button
          @click="activeTab = 'rendered'"
          :class="activeTab === 'rendered' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
          class="px-4 py-2 font-semibold transition-colors"
        >
          ğŸ“„ ë Œë”ë§ ë³´ê¸°
        </button>
        <button
          @click="activeTab = 'html'"
          :class="activeTab === 'html' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
          class="px-4 py-2 font-semibold transition-colors"
        >
          ğŸ§¾ HTML ì½”ë“œ ë³´ê¸°
        </button>
        <button
          @click="activeTab = 'attachments'"
          :class="activeTab === 'attachments' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
          class="px-4 py-2 font-semibold transition-colors"
        >
          ğŸ“¥ ì²¨ë¶€íŒŒì¼ (<span x-text="selectedRow.attachment_count || '0'"></span>)
        </button>
      </div>
    </div>

    <!-- íƒ­ ì½˜í…ì¸  -->
    <div class="mt-4">
      <!-- ë Œë”ë§ ë³´ê¸° -->
      <div x-show="activeTab === 'rendered'" class="prose prose-sm max-w-none">
        <div x-html="selectedRow.summary"></div>
      </div>

      <!-- HTML ì½”ë“œ ë³´ê¸° -->
      <div x-show="activeTab === 'html'" class="bg-gray-100 p-4 rounded-lg overflow-x-auto">
        <pre class="text-xs text-gray-700"><code x-text="selectedRow.summary"></code></pre>
      </div>

      <!-- ì²¨ë¶€íŒŒì¼ -->
      <div x-show="activeTab === 'attachments'">
        <p class="text-sm text-gray-600 mb-3">ğŸ“ ì²¨ë¶€íŒŒì¼ ëª©ë¡:</p>
        <div x-show="(!selectedRow.attachments || selectedRow.attachments.length === 0)" class="text-blue-600 text-sm">
          ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
        <div x-show="selectedRow.attachments && selectedRow.attachments.length > 0" class="space-y-2">
          <template x-for="attachment in selectedRow.attachments" :key="attachment.name">
            <div class="flex items-center gap-2 p-2 bg-gray-100 rounded-lg">
              <i class="bi bi-file-earmark"></i>
              <a :href="attachment.url" :download="attachment.name" class="text-blue-500 hover:underline flex-1">
                <span x-text="attachment.name"></span>
              </a>
              <button
                @click="downloadAttachment(attachment.url, attachment.name)"
                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
              >
                ğŸ“¥ ë‹¤ìš´ë¡œë“œ
              </button>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
  function dashboardData() {
    return {
      data: {
        site_count: '-',
        today_collect: '-',
        three_days_collect: '-',
        seven_days_collect: '-',
        total_collect: '-',
        error_count: 0
      },
      selectedPeriod: 'today',
      activeTab: 'rendered',
      isLoading: false,
      tableData: [],
      selectedRow: null,

      init() {
        this.loadDashboardMetrics();
        this.loadData('today');
      },

      async loadDashboardMetrics() {
        try {
          const response = await fetch('/api/v1/dashboard/metrics');
          if (response.ok) {
            this.data = await response.json();
          }
        } catch (error) {
          console.error('ëŒ€ì‹œë³´ë“œ ë©”íŠ¸ë¦­ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      },

      async loadData(period) {
        this.isLoading = true;
        try {
          const response = await fetch(`/api/v1/dashboard/data?period=${period}`);
          if (response.ok) {
            this.tableData = await response.json();
            this.selectedRow = null; // ë°ì´í„° ë¡œë“œ ì‹œ ì„ íƒ ì´ˆê¸°í™”
          }
        } catch (error) {
          console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
          this.tableData = [];
        } finally {
          this.isLoading = false;
        }
      },

      selectRow(row) {
        this.selectedRow = row;
        this.activeTab = 'rendered';
      },

      downloadAttachment(url, name) {
        const link = document.createElement('a');
        link.href = url;
        link.download = name;
        link.click();
      }
    };
  }
</script>
{% endblock %}
