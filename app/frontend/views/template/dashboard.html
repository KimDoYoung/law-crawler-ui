{% extends "common/base.html" %} {% block style %}
<style>
  .css_title_blue {
    color: rgb(3, 97, 179) !important;
    font-weight: bold !important;
  }
</style>
{% endblock %} {% block content %}
<div x-data="dashboardData()">
  <!-- í˜ì´ì§€ ì œëª© -->
  <div class="flex items-center gap-4 mb-4">
    <div class="flex items-baseline gap-2">
      <h1 class="text-3xl font-bold text-gray-800">ğŸ“Š ëŒ€ì‹œë³´ë“œ</h1>
      <p class="text-sm text-gray-600">ë²•ê·œê´€ë ¨ ë°ì´í„°ìˆ˜ì§‘ í˜„í™©</p>
    </div>

    <!-- ë©”íŠ¸ë¦­ ì¹´ë“œ í† ê¸€ ìŠ¤ìœ„ì¹˜ -->
    <div class="flex items-center">
      <button
        @click="showMetrics = !showMetrics"
        :class="showMetrics ? 'bg-blue-500' : 'bg-gray-300'"
        class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none"
      >
        <span
          :class="showMetrics ? 'translate-x-6' : 'translate-x-1'"
          class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
        ></span>
      </button>
      <span
        class="ml-2 text-xs text-gray-500 cursor-pointer select-none"
        @click="showMetrics = !showMetrics"
        x-text="showMetrics ? 'ì£¼ìš” ì§€í‘œ ìˆ¨ê¸°ê¸°' : 'ì£¼ìš” ì§€í‘œ ë³´ì´ê¸°'"
      ></span>
    </div>
  </div>

  <!-- ì£¼ìš” ì§€í‘œ (ë©”íŠ¸ë¦­ ì¹´ë“œ) - 1ì¤„ì— 5ê°œ -->
  <div
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 mb-3"
    x-show="showMetrics"
    x-transition
  >
    <!-- ì˜¤ëŠ˜ ìˆ˜ì§‘ -->
    <div
      class="bg-white border-l-4 border-blue-400 shadow hover:shadow-md transition-shadow rounded-lg p-4"
    >
      <div class="text-gray-500 text-xs font-semibold uppercase">
        ì˜¤ëŠ˜ ìˆ˜ì§‘ (ì²¨ë¶€íŒŒì¼)
      </div>
      <div
        class="text-2xl font-bold text-blue-600 mt-1"
        x-text="formatNumber(data.today_collect) || '-'"
      ></div>
    </div>

    <!-- 3ì¼ ì „ -->
    <div
      class="bg-white border-l-4 border-blue-400 shadow hover:shadow-md transition-shadow rounded-lg p-4"
    >
      <div class="text-gray-500 text-xs font-semibold uppercase">
        3ì¼ ì „ (ì²¨ë¶€íŒŒì¼)
      </div>
      <div
        class="text-2xl font-bold text-blue-600 mt-1"
        x-text="formatNumber(data.three_days_collect) || '-'"
      ></div>
    </div>

    <!-- 7ì¼ ì „ -->
    <div
      class="bg-white border-l-4 border-blue-400 shadow hover:shadow-md transition-shadow rounded-lg p-4"
    >
      <div class="text-gray-500 text-xs font-semibold uppercase">
        7ì¼ ì „ (ì²¨ë¶€íŒŒì¼)
      </div>
      <div
        class="text-2xl font-bold text-blue-600 mt-1"
        x-text="formatNumber(data.seven_days_collect) || '-'"
      ></div>
    </div>

    <!-- ì „ì²´ -->
    <div
      class="bg-white border-l-4 border-blue-400 shadow hover:shadow-md transition-shadow rounded-lg p-4"
    >
      <div class="text-gray-500 text-xs font-semibold uppercase">
        ì „ì²´ (ì²¨ë¶€íŒŒì¼)
      </div>
      <div
        class="text-2xl font-bold text-blue-600 mt-1"
        x-text="formatNumber(data.total_collect) || '-'"
      ></div>
    </div>

    <!-- ì˜¤ë¥˜ ë°œìƒ (ë¹¨ê°• ìƒ‰ìƒë§Œ ì‚¬ìš©) -->
    <div
      class="bg-white border-l-4 border-red-500 shadow hover:shadow-md transition-shadow rounded-lg p-4"
    >
      <div class="text-gray-500 text-xs font-semibold uppercase">ì˜¤ë¥˜ ë°œìƒ</div>
      <div
        class="text-2xl font-bold text-red-600 mt-1"
        x-text="formatNumber(data.error_count) || '0'"
      ></div>
    </div>
  </div>

  <hr class="my-3" />

  <!-- ìˆ˜ì§‘ëœ ë°ì´í„° ì¡°íšŒ -->
  <div class="bg-white rounded-lg shadow-sm p-4">
    <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“‹ ìˆ˜ì§‘ëœ ë°ì´í„° ì¡°íšŒ</h2>

    <!-- ë©”ì¸ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="border-b border-gray-200 mb-6">
      <div class="flex gap-4">
        <button
          @click="mainTab = 'results'"
          :class="mainTab === 'results' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
          class="px-4 py-2 font-semibold transition-colors"
        >
          ğŸ” ê²€ìƒ‰ê²°ê³¼
        </button>
        <button
          @click="mainTab = 'details'"
          :class="mainTab === 'details' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
          class="px-4 py-2 font-semibold transition-colors"
        >
          ğŸ“„ ìƒì„¸ì •ë³´
        </button>
      </div>
    </div>

    <!-- ê²€ìƒ‰ê²°ê³¼ íƒ­ -->
    <div x-show="mainTab === 'results'">
      <!-- ê¸°ê°„ ì„ íƒ ë²„íŠ¼ ë° í•„í„° -->
      <div class="flex flex-col gap-2 mb-6">
        <!-- ê¸°ê°„ ì„ íƒ ë²„íŠ¼ ë° í•„í„° ì„¹ì…˜ (í•œ ì¤„) -->
        <div class="flex gap-3 items-center">
          <!-- ê¸°ê°„ ì„ íƒ ë²„íŠ¼ -->
          <div class="flex gap-2">
            <button
              @click="selectedPeriod = 'today'; loadData('today')"
              :class="selectedPeriod === 'today' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
              class="px-4 py-2 rounded-lg font-semibold transition-colors"
            >
              ì˜¤ëŠ˜
            </button>
            <button
              @click="selectedPeriod = '3days'; loadData('3days')"
              :class="selectedPeriod === '3days' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
              class="px-4 py-2 rounded-lg font-semibold transition-colors"
            >
              3ì¼
            </button>
            <button
              @click="selectedPeriod = '7days'; loadData('7days')"
              :class="selectedPeriod === '7days' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
              class="px-4 py-2 rounded-lg font-semibold transition-colors"
            >
              7ì¼
            </button>
          </div>

          <!-- í•„í„° ì„¹ì…˜ -->
          <div
            class="flex gap-3 items-end flex-1 bg-gray-50 p-2 rounded-lg border border-gray-200"
          >
            <!-- ì‚¬ì´íŠ¸ ì„ íƒ -->
            <div class="flex-1">
              <label class="block text-xs font-semibold text-gray-700 mb-0.5"
                >ì‚¬ì´íŠ¸</label
              >
              <select
                aria-label="ì‚¬ì´íŠ¸ì„ íƒ"
                x-model="filterSite"
                @change="applyFilters()"
                class="w-full px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">ì „ì²´</option>
                <template x-for="site in uniqueSites" :key="site">
                  <option :value="site" x-text="site"></option>
                </template>
              </select>
            </div>

            <!-- ì œëª© ê²€ìƒ‰ -->
            <div class="flex-1">
              <label class="block text-xs font-semibold text-gray-700 mb-0.5"
                >ì œëª©</label
              >
              <input
                type="text"
                x-model="filterTitle"
                @input="applyFilters()"
                placeholder="ê²€ìƒ‰..."
                class="w-full px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <!-- í•„í„° ì´ˆê¸°í™” ë²„íŠ¼ -->
            <button
              @click="clearFilters()"
              class="px-3 py-1.5 bg-gray-400 text-white rounded font-semibold hover:bg-gray-500 transition-colors text-sm"
            >
              ì´ˆê¸°í™”
            </button>
          </div>
        </div>

        <!-- í•„í„° ê²°ê³¼ ì •ë³´ -->
        <div class="text-xs text-gray-600">
          <span x-show="filteredTableData.length > 0">
            í•„í„° ì ìš©: <strong x-text="filteredTableData.length"></strong>ê°œ /
            ì „ì²´: <strong x-text="tableData.length"></strong>ê°œ
          </span>
          <span
            x-show="filteredTableData.length === 0 && tableData.length > 0"
            class="text-red-500"
          >
            âš ï¸ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
          </span>
        </div>
      </div>

      <!-- ë°ì´í„° í…Œì´ë¸” ë¡œë”© ì¤‘ -->
      <div x-show="isLoading" class="text-center py-8">
        <i class="bi bi-hourglass text-2xl text-blue-500"></i>
        <p class="text-gray-600 mt-2">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>

      <!-- ë°ì´í„° í…Œì´ë¸” -->
      <div x-show="!isLoading" class="overflow-x-auto">
        <table class="w-full border-collapse text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="border border-gray-300 px-4 py-2 text-left">ì‚¬ì´íŠ¸</th>
              <th class="border border-gray-300 px-4 py-2 text-left">í˜ì´ì§€</th>
              <th class="border border-gray-300 px-4 py-2 text-left">ì œëª©</th>
              <th class="border border-gray-300 px-4 py-2 text-left">ë“±ë¡ì¼</th>
              <th class="border border-gray-300 px-4 py-2 text-left">
                ìˆ˜ì§‘ì¼ì‹œ
              </th>
              <th class="border border-gray-300 px-4 py-2 text-center">
                ì›ë³¸ì—´ê¸°
              </th>
            </tr>
          </thead>
          <tbody>
            <template
              x-for="(row, index) in filteredTableData"
              :key="`${row.site_name}-${row.page_id}-${row.real_seq}-${index}`"
            >
              <tr class="border-b border-gray-200 hover:bg-blue-50">
                <td class="border border-gray-300 px-4 py-2">
                  <a
                    :href="row.site_url"
                    target="_blank"
                    class="text-blue-500 hover:underline"
                  >
                    <span x-text="row.site_name"></span>
                  </a>
                </td>
                <td class="border border-gray-300 px-4 py-2">
                  <a
                    :href="row.detail_url"
                    target="_blank"
                    class="text-blue-500 hover:underline"
                  >
                    <span x-text="row.page_id"></span>
                  </a>
                </td>
                <td class="border border-gray-300 px-4 py-2 max-w-xs truncate">
                  <span
                    class="cursor-pointer text-gray-700 hover:text-blue-500"
                    @click="selectRow(row, $el)"
                    :title="row.title"
                    x-text="row.title"
                  ></span>
                </td>
                <td class="border border-gray-300 px-4 py-2">
                  <span x-text="row.registration_date || '-'"></span>
                </td>
                <td class="border border-gray-300 px-4 py-2">
                  <span x-text="row.collection_date"></span>
                </td>
                <td class="border border-gray-300 px-4 py-2 text-center">
                  <a
                    :href="row.org_url"
                    target="_blank"
                    class="text-blue-500 hover:underline"
                    >ì›ë³¸ì—´ê¸°</a
                  >
                </td>
              </tr>
            </template>
          </tbody>
        </table>

        <!-- ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° -->
        <div
          x-show="filteredTableData.length === 0"
          class="text-center py-8 text-gray-500"
        >
          <p x-show="tableData.length === 0">ì¡°íšŒ ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          <p x-show="tableData.length > 0">
            í•„í„° ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
          </p>
        </div>
      </div>
    </div>
    <!-- ê²€ìƒ‰ê²°ê³¼ íƒ­ ë -->

    <!-- ìƒì„¸ì •ë³´ íƒ­ -->
    <div x-show="mainTab === 'details'">
      <!-- selectedRowê°€ ìˆì„ ë•Œ -->
      <div x-show="selectedRow">
        <div class="space-y-3 mb-6">
          <!-- ì‚¬ì´íŠ¸ & í˜ì´ì§€ (ê°™ì€ ì¤„) -->
          <div class="flex gap-6">
            <div>
              <strong class="text-gray-700">ì‚¬ì´íŠ¸:</strong>
              <a
                :href="selectedRow?.site_url"
                target="_blank"
                rel="noopener noreferrer"
                class="text-blue-500 hover:underline ml-2"
              >
                <span x-text="selectedRow?.site_name"></span>
              </a>
            </div>
            <div>
              <strong class="text-gray-700">í˜ì´ì§€:</strong>
              <a
                :href="selectedRow?.detail_url"
                target="_blank"
                rel="noopener noreferrer"
                class="text-blue-500 hover:underline ml-2"
              >
                <span x-text="selectedRow?.page_id"></span>
              </a>
            </div>
          </div>

          <!-- ì œëª© (ê°•ì¡°) -->
          <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
            <strong class="text-gray-700">ì œëª©:</strong>
            <span
              class="ml-2 text-red-800 font-medium"
              x-text="selectedRow?.title"
            ></span>
          </div>

          <!-- ë“±ë¡ì¼ & ìˆ˜ì§‘ì¼ì‹œ (ê°™ì€ ì¤„) -->
          <div class="flex gap-6">
            <div>
              <strong class="text-gray-700">ë“±ë¡ì¼:</strong>
              <span
                class="ml-2"
                x-text="selectedRow?.registration_date || '-'"
              ></span>
            </div>
            <div>
              <strong class="text-gray-700">ìˆ˜ì§‘ì¼ì‹œ:</strong>
              <span class="ml-2" x-text="selectedRow?.collection_date"></span>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <strong class="text-gray-700">ë§í¬:</strong>
            <a
              :href="selectedRow?.org_url"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-block px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors"
            >
              <i class="bi bi-box-arrow-up-right"></i> ì›ë³¸ ì‚¬ì´íŠ¸ ì—´ê¸°
            </a>
            <button
              type="button"
              @click="mainTab = 'results'"
              class="inline-block px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition-colors"
            >
              <i class="bi bi-list"></i> ë¦¬ìŠ¤íŠ¸ë¡œ ëŒì•„ê°€ê¸°
            </button>
          </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="mt-6 border-b border-gray-200">
          <div class="flex gap-4">
            <button
              @click="activeTab = 'rendered'"
              :class="activeTab === 'rendered' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
              class="px-4 py-2 font-semibold transition-colors"
            >
              ğŸ“„ ë Œë”ë§ ë³´ê¸°
            </button>
            <button
              @click="activeTab = 'html'"
              :class="activeTab === 'html' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
              class="px-4 py-2 font-semibold transition-colors"
            >
              ğŸ§¾ HTML ì½”ë“œ ë³´ê¸°
            </button>
            <button
              @click="activeTab = 'attachments'"
              :class="activeTab === 'attachments' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
              class="px-4 py-2 font-semibold transition-colors"
            >
              ğŸ“¥ ì²¨ë¶€íŒŒì¼ (<span
                x-text="selectedRow?.attachment_count || '0'"
              ></span
              >)
            </button>
          </div>
        </div>

        <!-- íƒ­ ì½˜í…ì¸  -->
        <div class="mt-4">
          <!-- ë Œë”ë§ ë³´ê¸° -->
          <div
            x-show="activeTab === 'rendered'"
            class="prose prose-sm max-w-none"
          >
            <div x-html="selectedRow?.summary"></div>
          </div>

          <!-- HTML ì½”ë“œ ë³´ê¸° -->
          <div x-show="activeTab === 'html'">
            <div class="bg-gray-100 p-4 rounded-lg overflow-x-auto relative">
              <button
                @click="copyToClipboard(selectedRow?.summary)"
                class="absolute top-2 right-2 p-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                title="í´ë¦½ë³´ë“œ ë³µì‚¬"
              >
                <i class="bi bi-clipboard"></i>
              </button>
              <pre
                class="text-xs text-gray-700"
              ><code x-text="selectedRow?.summary"></code></pre>
            </div>
          </div>

          <!-- ì²¨ë¶€íŒŒì¼ -->
          <div x-show="activeTab === 'attachments'">
            <p class="text-sm text-gray-600 mb-3">ì²¨ë¶€íŒŒì¼ ëª©ë¡:</p>
            <div
              x-show="(!selectedRow?.attachments || selectedRow?.attachments.length === 0)"
              class="text-blue-600 text-sm"
            >
              ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
            <div
              x-show="selectedRow?.attachments && selectedRow?.attachments.length > 0"
              class="space-y-2"
            >
              <template
                x-for="attachment in selectedRow?.attachments || []"
                :key="attachment.name"
              >
                <div class="flex items-center gap-2 p-2 bg-gray-100 rounded-lg">
                  <i class="bi bi-file-earmark"></i>
                  <a
                    :href="attachment.url"
                    :download="attachment.name"
                    class="text-blue-500 hover:underline flex-1"
                  >
                    <span x-text="attachment.name"></span>
                  </a>
                  <button
                    @click="downloadAttachment(attachment.url, attachment.name)"
                    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
                  >
                    ğŸ“¥ ë‹¤ìš´ë¡œë“œ
                  </button>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- selectedRowê°€ ì—†ì„ ë•Œ -->
      <div x-show="!selectedRow" class="text-center py-8 text-gray-500">
        <p>ê²€ìƒ‰ê²°ê³¼ íƒ­ì—ì„œ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</p>
      </div>
    </div>
    <!-- ìƒì„¸ì •ë³´ íƒ­ ë -->
  </div>
</div>
{% endblock %} {% block script %}
<script>
  function dashboardData() {
    return {
      data: {
        site_count: "-",
        today_collect: "-",
        three_days_collect: "-",
        seven_days_collect: "-",
        total_collect: "-",
        error_count: 0,
      },
      showMetrics: true,
      selectedPeriod: "today",
      mainTab: "results",
      activeTab: "rendered",
      isLoading: false,
      tableData: [],
      filteredTableData: [],
      selectedRow: null,
      filterSite: "",
      filterTitle: "",
      uniqueSites: [],

      init() {
        console.log("âœ… dashboardData ì´ˆê¸°í™”");
        this.loadDashboardMetrics();
        this.selectedPeriod = "today"; // ì˜¤ëŠ˜ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        this.loadData("today"); // ì˜¤ëŠ˜ ë°ì´í„° ë¡œë“œ
        // í¬ë¡¤ëŸ¬ í—¬ìŠ¤ ì²´í¬ ì¦‰ì‹œ í˜¸ì¶œ (ëŒ€ì‹œë³´ë“œì—ì„œë§Œ)
        if (typeof updateCrawlerHealth === 'function') {
          updateCrawlerHealth();
        }
      },

      async loadDashboardMetrics() {
        try {
          const response = await fetch("/api/v1/dashboard/metrics");
          if (response.ok) {
            this.data = await response.json();
            console.log("ğŸ“Š ë©”íŠ¸ë¦­ ë¡œë“œ ì™„ë£Œ:", this.data);
          }
        } catch (error) {
          console.error("ëŒ€ì‹œë³´ë“œ ë©”íŠ¸ë¦­ ë¡œë“œ ì‹¤íŒ¨:", error);
        }
      },

      async loadData(period) {
        // CSS í´ë˜ìŠ¤ ì œê±°
        document.querySelectorAll(".css_title_blue").forEach((el) => {
          el.classList.remove("css_title_blue");
        });

        this.isLoading = true;
        this.mainTab = "results"; // ë°ì´í„° ë¡œë“œ ì‹œ ê²€ìƒ‰ê²°ê³¼ íƒ­ìœ¼ë¡œ ì „í™˜
        try {
          const response = await fetch(
            `/api/v1/dashboard/data?period=${period}`,
          );
          if (response.ok) {
            this.tableData = await response.json();
            console.log(
              `ğŸ“Š ${period} ë°ì´í„° ë¡œë“œ ì™„ë£Œ:`,
              this.tableData.length,
              "ê±´",
            );
            this.selectedRow = null; // ë°ì´í„° ë¡œë“œ ì‹œ ì„ íƒ ì´ˆê¸°í™”
            this.filterSite = ""; // í•„í„° ì´ˆê¸°í™”
            this.filterTitle = "";
            this.updateUniqueSites(); // ê³ ìœ  ì‚¬ì´íŠ¸ ì—…ë°ì´íŠ¸
            this.applyFilters(); // í•„í„° ì ìš©
          }
        } catch (error) {
          console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
          this.tableData = [];
        } finally {
          this.isLoading = false;
        }
      },

      updateUniqueSites() {
        // ê³ ìœ í•œ ì‚¬ì´íŠ¸ ëª©ë¡ ì¶”ì¶œ
        const sites = [...new Set(this.tableData.map((row) => row.site_name))];
        this.uniqueSites = sites.sort();
      },

      applyFilters() {
        // í•„í„° ì¡°ê±´ì— ë”°ë¼ í…Œì´ë¸” ë°ì´í„° í•„í„°ë§
        this.filteredTableData = this.tableData.filter((row) => {
          // ì‚¬ì´íŠ¸ í•„í„°
          if (this.filterSite && row.site_name !== this.filterSite) {
            return false;
          }

          // ì œëª© í•„í„° (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì•ˆí•¨)
          if (
            this.filterTitle &&
            !row.title.toLowerCase().includes(this.filterTitle.toLowerCase())
          ) {
            return false;
          }

          return true;
        });
      },

      clearFilters() {
        // CSS í´ë˜ìŠ¤ ì œê±°
        document.querySelectorAll(".css_title_blue").forEach((el) => {
          el.classList.remove("css_title_blue");
        });

        this.filterSite = "";
        this.filterTitle = "";
        this.applyFilters();
      },

      selectRow(row, titleElement) {
        console.log("ğŸ”· selectRow í˜¸ì¶œ");
        console.log("ğŸ“ ì„ íƒëœ row:", row);

        // ì´ì „ì— ì ìš©ëœ CSS ì œê±°
        document.querySelectorAll(".css_title_blue").forEach((el) => {
          el.classList.remove("css_title_blue");
        });

        // ìƒˆë¡œ í´ë¦­í•œ ì œëª© spanì— CSS í´ë˜ìŠ¤ ì ìš©
        if (titleElement) {
          titleElement.classList.add("css_title_blue");
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        this.selectedRow = row;
        this.activeTab = "rendered";
        this.mainTab = "details";

        // ì²¨ë¶€íŒŒì¼ ë¡œë“œ
        this.loadAttachments();

        console.log("âœ… ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
        console.log("   mainTab:", this.mainTab);
        console.log("   activeTab:", this.activeTab);
        console.log("   selectedRow:", this.selectedRow ? "YES" : "NO");
      },

      async loadAttachments() {
        if (!this.selectedRow) return;

        const { site_code, page_code, real_seq } = this.selectedRow;

        try {
          const response = await fetch(
            `/api/v1/dashboard/attachments/${site_code}/${page_code}/${real_seq}`,
          );
          if (response.ok) {
            const data = await response.json();
            this.selectedRow.attachment_count = data.count;
            this.selectedRow.attachments = data.items;
            console.log(`âœ… ì²¨ë¶€íŒŒì¼ ë¡œë“œ ì™„ë£Œ: ${data.count}ê°œ`);
          }
        } catch (error) {
          console.error("ì²¨ë¶€íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:", error);
          this.selectedRow.attachment_count = 0;
          this.selectedRow.attachments = [];
        }
      },

      copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            alert("ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
          })
          .catch(() => {
            alert("âŒ ë³µì‚¬ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          });
      },

      downloadAttachment(url, name) {
        const link = document.createElement("a");
        link.href = url;
        link.download = name;
        link.click();
      },

      formatNumber(value) {
        if (!value || value === "-") return value;

        // ë¬¸ìì—´ ê°’ ì²˜ë¦¬ (ì˜ˆ: "100 (50)" í˜•íƒœ)
        if (typeof value === "string") {
          const match = value.match(/^(\d+)\s*\((\d+)\)$/);
          if (match) {
            const num1 = parseInt(match[1]).toLocaleString("en-US");
            const num2 = parseInt(match[2]).toLocaleString("en-US");
            return `${num1} (${num2})`;
          }
          // ìˆœìˆ˜ ìˆ«ìë§Œ ìˆëŠ” ê²½ìš°
          const num = parseInt(value);
          if (!isNaN(num)) {
            return num.toLocaleString("en-US");
          }
          return value;
        }

        // ìˆ«ì ê°’ ì²˜ë¦¬
        if (typeof value === "number") {
          return value.toLocaleString("en-US");
        }

        return value;
      },
    };
  }
</script>
{% endblock %}
