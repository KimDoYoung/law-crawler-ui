{% extends "common/base.html" %}

{% block style %}
<style>
  .css_title_blue {
    color: rgb(3, 97, 179) !important;
    font-weight: bold !important;
  }
</style>
{% endblock %}

{% block content %}
<div x-data="searchData()">
  <!-- í˜ì´ì§€ ì œëª© -->
  <div class="flex items-baseline gap-2 mb-4">
    <h1 class="text-3xl font-bold text-gray-800">ğŸ” ë°ì´í„° ì¡°íšŒ</h1>
    <p class="text-sm text-gray-600">í‚¤ì›Œë“œë¡œ ë²•ê·œ ë°ì´í„°ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤</p>
  </div>

  <!-- ê²€ìƒ‰ ì˜ì—­ -->
  <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
    <div class="flex gap-3 items-end">
      <!-- ì‚¬ì´íŠ¸ ì„ íƒ (ë“œë¡­ë‹¤ìš´) -->
      <div class="flex-1 relative">
        <label class="block text-sm font-semibold text-gray-700 mb-2">ì‚¬ì´íŠ¸</label>

        <!-- select ë°•ìŠ¤ì²˜ëŸ¼ ë³´ì´ëŠ” ë²„íŠ¼ -->
        <button
          @click="showSiteDropdown = !showSiteDropdown"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg text-left bg-white hover:border-blue-500 flex justify-between items-center text-sm transition-colors"
        >
          <span x-text="selectedSitesText || 'ëª¨ë“  ì‚¬ì´íŠ¸'"></span>
          <i :class="showSiteDropdown ? 'bi bi-chevron-up' : 'bi bi-chevron-down'" class="text-gray-500"></i>
        </button>

        <!-- ë“œë¡­ë‹¤ìš´ íŒ¨ë„ (3ì—´ ê·¸ë¦¬ë“œ) -->
        <div
          x-show="showSiteDropdown"
          @click.outside="showSiteDropdown = false"
          class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-64 overflow-y-auto"
        >
          <!-- ëª¨ë‘ì„ íƒ/í•´ì œ ë²„íŠ¼ -->
          <div class="sticky top-0 bg-white p-3 border-b border-gray-200 flex gap-2">
            <button
              @click="selectAllSitesClick()"
              class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors"
            >
              ëª¨ë‘ì„ íƒ
            </button>
            <button
              @click="deselectAllSites()"
              class="px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 transition-colors"
            >
              ëª¨ë‘í•´ì œ
            </button>
            <span class="text-xs text-gray-600 ml-auto">
              <span x-text="`${selectedSites.length}/${sites.length}`"></span>
            </span>
          </div>

          <!-- ì‚¬ì´íŠ¸ ê·¸ë¦¬ë“œ (3ì—´) -->
          <div class="p-3 grid grid-cols-3 gap-2">
            <template x-for="site in sites" :key="site.code">
              <label class="flex items-center p-2 rounded hover:bg-blue-50 cursor-pointer text-xs">
                <input
                  type="checkbox"
                  @change="toggleSite(site.code)"
                  :checked="selectedSites.includes(site.code)"
                  class="w-4 h-4 rounded cursor-pointer"
                />
                <span class="ml-2 text-gray-700 truncate" :title="site.name">
                  <span x-text="site.name"></span>
                </span>
              </label>
            </template>
          </div>
        </div>
      </div>

      <!-- ê²€ìƒ‰ í‚¤ì›Œë“œ -->
      <div class="flex-1">
        <label class="block text-sm font-semibold text-gray-700 mb-1">ê²€ìƒ‰ í‚¤ì›Œë“œ</label>
        <input
          type="text"
          x-model="keyword"
          @keydown.enter="performSearch()"
          placeholder="ê²€ìƒ‰..."
          class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      <!-- ë²„íŠ¼ -->
      <div class="flex gap-2">
        <button
          @click="performSearch()"
          :disabled="selectedSites.length === 0"
          :class="selectedSites.length === 0
            ? 'opacity-50 cursor-not-allowed bg-gray-400'
            : 'hover:bg-blue-600 bg-blue-500'"
          class="px-4 py-2 text-white rounded-lg transition-colors text-sm"
          :title="selectedSites.length === 0 ? 'ì‚¬ì´íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”' : 'ê²€ìƒ‰'"
        >
          <i class="bi bi-search"></i>
        </button>
        <button
          @click="resetSearch()"
          class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors text-sm"
        >
          ì´ˆê¸°í™”
        </button>
      </div>
    </div>
  </div>

  <!-- ê²€ìƒ‰ ê²°ê³¼ -->
  <div x-show="searchPerformed" class="bg-white rounded-lg shadow-sm p-4">
    <!-- ë¡œë”© ìƒíƒœ -->
    <div x-show="isLoading" class="text-center py-8">
      <i class="bi bi-hourglass text-2xl text-blue-500"></i>
      <p class="text-gray-600 mt-2">ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <!-- ê²°ê³¼ ì—†ìŒ -->
    <div
      x-show="!isLoading && results.length === 0"
      class="text-center py-8 text-blue-600"
    >
      <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div x-show="!isLoading && results.length > 0" class="border-b border-gray-200 mb-4">
      <div class="flex gap-4">
        <button
          @click="activeResultTab = 'results'"
          :class="activeResultTab === 'results' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
          class="px-4 py-2 font-semibold transition-colors"
        >
          ğŸ“‹ ê²€ìƒ‰ê²°ê³¼
          <span class="text-sm text-gray-500" x-text="`(${formatNumber(totalCount)}ê±´)`"></span>
        </button>
        <button
          @click="activeResultTab = 'details'"
          :class="activeResultTab === 'details' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
          :disabled="!selectedRow"
          :class.disabled="!selectedRow ? 'opacity-50 cursor-not-allowed' : ''"
          class="px-4 py-2 font-semibold transition-colors"
        >
          ğŸ“„ ìƒì„¸ ì •ë³´
        </button>
      </div>
    </div>

    <!-- ê²€ìƒ‰ê²°ê³¼ íƒ­ -->
    <div x-show="activeResultTab === 'results'" class="space-y-4">
      <!-- í˜ì´ì§€ í¬ê¸° ì„ íƒ -->
      <div class="flex items-center justify-end gap-2">
        <label class="text-sm text-gray-700">í˜ì´ì§€ í¬ê¸°:</label>
        <select
          @change="changePageSize($event.target.value)"
          :value="pageSize"
          class="px-3 py-1 border border-gray-300 rounded text-sm"
        >
          <option value="10">10ê°œ</option>
          <option value="30">30ê°œ</option>
          <option value="50">50ê°œ</option>
          <option value="100">100ê°œ</option>
        </select>
      </div>

      <!-- í…Œì´ë¸” -->
      <div class="overflow-x-auto">
        <table class="w-full border-collapse text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="border border-gray-300 px-4 py-2 text-left">ì‚¬ì´íŠ¸</th>
              <th class="border border-gray-300 px-4 py-2 text-left">í˜ì´ì§€</th>
              <th class="border border-gray-300 px-4 py-2 text-left">ì œëª©</th>
              <th class="border border-gray-300 px-4 py-2 text-left">ë“±ë¡ì¼</th>
              <th class="border border-gray-300 px-4 py-2 text-left">ìˆ˜ì§‘ì¼ì‹œ</th>
              <th class="border border-gray-300 px-4 py-2 text-center">ì›ë³¸ì—´ê¸°</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(row, index) in results" :key="`${row.site_name}-${row.page_id}-${row.real_seq}-${index}`">
              <tr class="border-b border-gray-200 hover:bg-blue-50 cursor-pointer">
                <td class="border border-gray-300 px-4 py-2">
                  <a
                    :href="row.site_url"
                    target="_blank"
                    rel="noopener noreferrer"
                    @click.stop
                    class="text-blue-500 hover:underline"
                  >
                    <span x-text="row.site_name"></span>
                  </a>
                </td>
                <td class="border border-gray-300 px-4 py-2">
                  <a
                    :href="row.detail_url"
                    target="_blank"
                    rel="noopener noreferrer"
                    @click.stop
                    class="text-blue-500 hover:underline"
                  >
                    <span x-text="row.page_id"></span>
                  </a>
                </td>
                <td class="border border-gray-300 px-4 py-2 max-w-xs truncate">
                  <span
                    class="cursor-pointer text-gray-700 hover:text-blue-500"
                    @click="selectRow(row, $el)"
                    :title="row.title"
                    x-text="row.title"
                  ></span>
                </td>
                <td class="border border-gray-300 px-4 py-2">
                  <span x-text="row.registration_date || '-'"></span>
                </td>
                <td class="border border-gray-300 px-4 py-2">
                  <span x-text="row.collection_date"></span>
                </td>
                <td class="border border-gray-300 px-4 py-2 text-center">
                  <a
                    :href="row.org_url"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-block px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors"
                    title="ì›ë³¸ ì‚¬ì´íŠ¸ ì—´ê¸°"
                  >
                    <i class="bi bi-box-arrow-up-right"></i> ì—´ê¸°
                  </a>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <!-- í˜ì´ì§• ë„¤ë¹„ê²Œì´ì…˜ -->
      <div class="flex justify-center items-center gap-2 mt-6 flex-wrap">
        <!-- ì´ì „ í˜ì´ì§€ -->
        <button
          @click="goToPage(currentPage - 1)"
          :disabled="currentPage === 1"
          :class="currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'"
          class="px-3 py-1 border border-gray-300 rounded text-sm transition-colors"
        >
          â—€ ì´ì „
        </button>

        <!-- í˜ì´ì§€ ë²ˆí˜¸ -->
        <template x-for="page in paginationPages" :key="page">
          <button
            @click="goToPage(page)"
            :class="page === currentPage
              ? 'bg-blue-500 text-white'
              : 'border border-gray-300 hover:bg-gray-100'"
            class="px-3 py-1 rounded text-sm transition-colors"
            x-text="page"
          ></button>
        </template>

        <!-- ë‹¤ìŒ í˜ì´ì§€ -->
        <button
          @click="goToPage(currentPage + 1)"
          :disabled="currentPage >= totalPages"
          :class="currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'"
          class="px-3 py-1 border border-gray-300 rounded text-sm transition-colors"
        >
          ë‹¤ìŒ â–¶
        </button>

        <!-- í˜ì´ì§€ ì •ë³´ -->
        <span class="text-sm text-gray-600 ml-2">
          <span x-text="`${currentPage} / ${totalPages}`"></span>
        </span>
      </div>
    </div>

    <!-- ìƒì„¸ ì •ë³´ íƒ­ -->
    <div x-show="activeResultTab === 'details' && selectedRow" class="space-y-4">
      <!-- ìƒì„¸ ì •ë³´ í•­ëª© -->
      <div class="space-y-3 mb-6">
        <div>
          <strong class="text-gray-700">ì‚¬ì´íŠ¸:</strong>
          <a
            :href="selectedRow.site_url"
            target="_blank"
            rel="noopener noreferrer"
            class="text-blue-500 hover:underline ml-2"
          >
            <span x-text="selectedRow.site_name"></span>
          </a>
        </div>
        <div>
          <strong class="text-gray-700">í˜ì´ì§€:</strong>
          <a
            :href="selectedRow.detail_url"
            target="_blank"
            rel="noopener noreferrer"
            class="text-blue-500 hover:underline ml-2"
          >
            <span x-text="selectedRow.page_id"></span>
          </a>
        </div>
        <div>
          <strong class="text-gray-700">ì œëª©:</strong>
          <span class="ml-2" x-text="selectedRow.title"></span>
        </div>
        <div>
          <strong class="text-gray-700">ë“±ë¡ì¼:</strong>
          <span class="ml-2" x-text="selectedRow.registration_date || '-'"></span>
        </div>
        <div>
          <strong class="text-gray-700">ìˆ˜ì§‘ì¼ì‹œ:</strong>
          <span class="ml-2" x-text="selectedRow.collection_date"></span>
        </div>
        <div class="flex items-center gap-3">
          <strong class="text-gray-700">ë§í¬:</strong>
          <a
            :href="selectedRow.org_url"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-block px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors"
          >
            <i class="bi bi-box-arrow-up-right"></i> ì›ë³¸ ì‚¬ì´íŠ¸ ì—´ê¸°
          </a>
          <button
            type="button"
            @click="activeResultTab = 'results'"
            class="inline-block px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition-colors"
          >
            <i class="bi bi-list"></i> ë¦¬ìŠ¤íŠ¸ë¡œ ëŒì•„ê°€ê¸°
          </button>
        </div>
      </div>

      <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
      <div class="border-b border-gray-200">
        <div class="flex gap-4">
          <button
            type="button"
            @click="activeTab = 'rendered'"
            :class="activeTab === 'rendered' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
            class="px-4 py-2 font-semibold transition-colors"
          >
            ğŸ“„ ë Œë”ë§ ë³´ê¸°
          </button>
          <button
            type="button"
            @click="activeTab = 'html'"
            :class="activeTab === 'html' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
            class="px-4 py-2 font-semibold transition-colors"
          >
            ğŸ§¾ HTML ì½”ë“œ ë³´ê¸°
          </button>
        </div>
      </div>

      <!-- íƒ­ ì½˜í…ì¸  -->
      <div class="mt-4">
        <!-- ë Œë”ë§ ë³´ê¸° -->
        <div x-show="activeTab === 'rendered'" class="prose prose-sm max-w-none">
          <div x-html="selectedRow.summary"></div>
        </div>

        <!-- HTML ì½”ë“œ ë³´ê¸° -->
        <div
          x-show="activeTab === 'html'"
          class="bg-gray-100 p-4 rounded-lg overflow-x-auto relative"
        >
          <button
            type="button"
            @click="copyToClipboard(selectedRow.summary)"
            class="absolute top-2 right-2 p-2 bg-white rounded hover:bg-gray-200 transition-colors"
            title="í´ë¦½ë³´ë“œì— ë³µì‚¬"
          >
            <i class="bi bi-clipboard-check text-gray-700"></i>
          </button>
          <pre
            class="text-xs text-gray-700 pr-10"
          ><code x-text="selectedRow.summary"></code></pre>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block script %}
<script>
  function searchData() {
    return {
      sites: [],
      selectedSites: [],
      selectAllSites: false,
      showSiteDropdown: false,
      keyword: "",
      results: [],
      selectedRow: null,
      searchPerformed: false,
      isLoading: false,
      activeTab: "rendered",
      activeResultTab: "results",
      pageSize: 10,
      currentPage: 1,
      totalCount: 0,

      get selectedSitesText() {
        if (this.selectedSites.length === 0) return "ì‚¬ì´íŠ¸ ì—†ìŒ";
        if (this.selectedSites.length === this.sites.length)
          return "ëª¨ë“  ì‚¬ì´íŠ¸";
        const names = this.selectedSites.map((code) => {
          const site = this.sites.find((s) => s.code === code);
          return site ? site.name : code;
        });
        return (
          names.slice(0, 2).join(", ") +
          (names.length > 2 ? ` ì™¸ ${names.length - 2}ê°œ` : "")
        );
      },

      init() {
        this.loadSites();
      },

      async loadSites() {
        try {
          const response = await fetch("/api/v1/search/sites");
          if (response.ok) {
            this.sites = await response.json();
            // ì´ˆê¸° ìƒíƒœ: ëª¨ë“  ì‚¬ì´íŠ¸ ì„ íƒ
            this.selectedSites = this.sites.map((s) => s.code);
            this.selectAllSites = true;
          }
        } catch (error) {
          console.error("ì‚¬ì´íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", error);
        }
      },

      toggleSite(code) {
        const index = this.selectedSites.indexOf(code);
        if (index > -1) {
          this.selectedSites.splice(index, 1);
        } else {
          this.selectedSites.push(code);
        }
        this.selectAllSites = this.selectedSites.length === this.sites.length;
      },

      selectAllSitesClick() {
        // ëª¨ë‘ì„ íƒ ë²„íŠ¼ í´ë¦­
        this.selectedSites = this.sites.map((s) => s.code);
        this.selectAllSites = true;
      },

      deselectAllSites() {
        // ëª¨ë‘í•´ì œ ë²„íŠ¼ í´ë¦­
        this.selectedSites = [];
        this.selectAllSites = false;
      },

      toggleAllSites() {
        // (ë ˆê±°ì‹œ) ì´ì „ì˜ í† ê¸€ í•¨ìˆ˜
        if (this.selectAllSites) {
          this.selectedSites = this.sites.map((s) => s.code);
        } else {
          this.selectedSites = [];
        }
      },

      async performSearch() {
        // ì‚¬ì´íŠ¸ ì„ íƒ ê²€ì¦
        if (this.selectedSites.length === 0) {
          alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ì‚¬ì´íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        // ê²€ìƒ‰ ì‹œì‘ ì‹œ ì´ì „ ì„ íƒ CSS ì œê±°
        document.querySelectorAll('.css_title_blue').forEach((el) => {
          el.classList.remove('css_title_blue');
        });

        // ê²€ìƒ‰ê²°ê³¼ íƒ­ìœ¼ë¡œ ì „í™˜
        this.activeResultTab = "results";

        this.isLoading = true;
        this.searchPerformed = true;
        try {
          // selectedSitesê°€ ë¹„ì–´ìˆìœ¼ë©´ ëª¨ë“  ì‚¬ì´íŠ¸ (ë¹ˆ ë¬¸ìì—´ ì „ì†¡)
          // selectedSitesê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì‚¬ì´íŠ¸ë“¤ë§Œ ì„ íƒ
          const sitesParam = this.selectedSites.join(",");
          const response = await fetch(
            `/api/v1/search/results?sites=${encodeURIComponent(
              sitesParam
            )}&keyword=${encodeURIComponent(this.keyword)}&page=${this.currentPage}&pagesize=${this.pageSize}`
          );
          if (response.ok) {
            const data = await response.json();
            this.results = data.items || [];
            this.totalCount = data.total || 0;
            this.currentPage = data.page || 1;
            this.selectedRow = null;
          }
        } catch (error) {
          console.error("ê²€ìƒ‰ ì‹¤íŒ¨:", error);
          this.results = [];
        } finally {
          this.isLoading = false;
        }
      },

      formatNumber(value) {
        return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      },

      resetSearch() {
        // ì„ íƒ CSS ì œê±°
        document.querySelectorAll('.css_title_blue').forEach((el) => {
          el.classList.remove('css_title_blue');
        });

        this.keyword = "";
        // ì´ˆê¸° ìƒíƒœë¡œ ë³µì›: ëª¨ë“  ì‚¬ì´íŠ¸ ì„ íƒ
        this.selectedSites = this.sites.map((s) => s.code);
        this.selectAllSites = true;
        this.results = [];
        this.selectedRow = null;
        this.searchPerformed = false;
        this.currentPage = 1;
        this.pageSize = 10;
      },

      selectRow(row, titleElement) {
        // 1. ëª¨ë“  ì œëª©ì—ì„œ css_title_blue í´ë˜ìŠ¤ ì œê±°
        document.querySelectorAll('.css_title_blue').forEach((el) => {
          el.classList.remove('css_title_blue');
        });

        // 2. í˜„ì¬ í´ë¦­í•œ ì œëª©ì—ë§Œ css_title_blue ì¶”ê°€
        if (titleElement) {
          titleElement.classList.add('css_title_blue');
        }

        // 3. ìƒì„¸ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        this.selectedRow = row;
        this.activeTab = "rendered";
        this.activeResultTab = "details";
      },

      isRowSelected(row) {
        // í˜„ì¬ ì„ íƒëœ í–‰ì¸ì§€ í™•ì¸
        if (!this.selectedRow) return false;
        return (
          this.selectedRow.site_name === row.site_name &&
          this.selectedRow.page_id === row.page_id &&
          this.selectedRow.real_seq === row.real_seq
        );
      },

      changePageSize(size) {
        this.pageSize = size;
        this.currentPage = 1;
        this.performSearch();
      },

      goToPage(page) {
        this.currentPage = page;
        this.performSearch();
      },

      copyToClipboard(text) {
        // í´ë¦½ë³´ë“œì— í…ìŠ¤íŠ¸ ë³µì‚¬
        navigator.clipboard.writeText(text).then(() => {
          alert("í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }).catch(err => {
          console.error("ë³µì‚¬ ì‹¤íŒ¨:", err);
          alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
      },

      get totalPages() {
        return Math.ceil(this.totalCount / this.pageSize);
      },

      get paginationPages() {
        const pages = [];
        const maxVisible = 5;
        let start = Math.max(1, this.currentPage - Math.floor(maxVisible / 2));
        let end = Math.min(this.totalPages, start + maxVisible - 1);

        if (end - start + 1 < maxVisible) {
          start = Math.max(1, end - maxVisible + 1);
        }

        for (let i = start; i <= end; i++) {
          pages.push(i);
        }
        return pages;
      },
    };
  }
</script>
{% endblock %}
