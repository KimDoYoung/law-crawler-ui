{% extends "common/base.html" %}

{% block style %}
<style>
  .css_title_blue {
    color: rgb(3, 97, 179) !important;
    font-weight: bold !important;
  }
</style>
{% endblock %}

{% block content %}
<div x-data="searchData()">
  <!-- 페이지 제목 -->
  <div class="flex items-baseline gap-2 mb-4">
    <h1 class="text-3xl font-bold text-gray-800">🔍 데이터 조회</h1>
    <p class="text-sm text-gray-600">키워드로 법규 데이터를 검색합니다</p>
  </div>

  <!-- 검색 영역 -->
  <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
    <div class="flex gap-3 items-end">
      <!-- 사이트 선택 (드롭다운) -->
      <div class="flex-1 relative">
        <label class="block text-sm font-semibold text-gray-700 mb-2">사이트</label>

        <!-- select 박스처럼 보이는 버튼 -->
        <button
          @click="showSiteDropdown = !showSiteDropdown"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg text-left bg-white hover:border-blue-500 flex justify-between items-center text-sm transition-colors"
        >
          <span x-text="selectedSitesText || '모든 사이트'"></span>
          <i :class="showSiteDropdown ? 'bi bi-chevron-up' : 'bi bi-chevron-down'" class="text-gray-500"></i>
        </button>

        <!-- 드롭다운 패널 (3열 그리드) -->
        <div
          x-show="showSiteDropdown"
          @click.outside="showSiteDropdown = false"
          class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-64 overflow-y-auto"
        >
          <!-- 모두선택/해제 버튼 -->
          <div class="sticky top-0 bg-white p-3 border-b border-gray-200 flex gap-2">
            <button
              @click="selectAllSitesClick()"
              class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors"
            >
              모두선택
            </button>
            <button
              @click="deselectAllSites()"
              class="px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 transition-colors"
            >
              모두해제
            </button>
            <span class="text-xs text-gray-600 ml-auto">
              <span x-text="`${selectedSites.length}/${sites.length}`"></span>
            </span>
          </div>

          <!-- 사이트 그리드 (3열) -->
          <div class="p-3 grid grid-cols-3 gap-2">
            <template x-for="site in sites" :key="site.code">
              <label class="flex items-center p-2 rounded hover:bg-blue-50 cursor-pointer text-xs">
                <input
                  type="checkbox"
                  @change="toggleSite(site.code)"
                  :checked="selectedSites.includes(site.code)"
                  class="w-4 h-4 rounded cursor-pointer"
                />
                <span class="ml-2 text-gray-700 truncate" :title="site.name">
                  <span x-text="site.name"></span>
                </span>
              </label>
            </template>
          </div>
        </div>
      </div>

      <!-- 검색 키워드 -->
      <div class="flex-1">
        <label class="block text-sm font-semibold text-gray-700 mb-1">검색 키워드</label>
        <input
          type="text"
          x-model="keyword"
          @keydown.enter="performSearch()"
          placeholder="검색..."
          class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>

      <!-- 버튼 -->
      <div class="flex gap-2">
        <button
          @click="performSearch()"
          :disabled="selectedSites.length === 0"
          :class="selectedSites.length === 0
            ? 'opacity-50 cursor-not-allowed bg-gray-400'
            : 'hover:bg-blue-600 bg-blue-500'"
          class="px-4 py-2 text-white rounded-lg transition-colors text-sm"
          :title="selectedSites.length === 0 ? '사이트를 선택하세요' : '검색'"
        >
          <i class="bi bi-search"></i>
        </button>
        <button
          @click="resetSearch()"
          class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors text-sm"
        >
          초기화
        </button>
      </div>
    </div>
  </div>

  <!-- 검색 결과 -->
  <div x-show="searchPerformed" class="bg-white rounded-lg shadow-sm p-4">
    <!-- 로딩 상태 -->
    <div x-show="isLoading" class="text-center py-8">
      <i class="bi bi-hourglass text-2xl text-blue-500"></i>
      <p class="text-gray-600 mt-2">검색 중입니다...</p>
    </div>

    <!-- 결과 없음 -->
    <div
      x-show="!isLoading && results.length === 0"
      class="text-center py-8 text-blue-600"
    >
      <p>검색 결과가 없습니다.</p>
    </div>

    <!-- 탭 네비게이션 -->
    <div x-show="!isLoading && results.length > 0" class="border-b border-gray-200 mb-4">
      <div class="flex gap-4">
        <button
          @click="activeResultTab = 'results'"
          :class="activeResultTab === 'results' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
          class="px-4 py-2 font-semibold transition-colors"
        >
          📋 검색결과
          <span class="text-sm text-gray-500" x-text="`(${formatNumber(totalCount)}건)`"></span>
        </button>
        <button
          @click="activeResultTab = 'details'"
          :class="activeResultTab === 'details' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
          :disabled="!selectedRow"
          :class.disabled="!selectedRow ? 'opacity-50 cursor-not-allowed' : ''"
          class="px-4 py-2 font-semibold transition-colors"
        >
          📄 상세 정보
        </button>
      </div>
    </div>

    <!-- 검색결과 탭 -->
    <div x-show="activeResultTab === 'results'" class="space-y-4">
      <!-- 페이지 크기 선택 -->
      <div class="flex items-center justify-end gap-2">
        <label class="text-sm text-gray-700">페이지 크기:</label>
        <select
          @change="changePageSize($event.target.value)"
          :value="pageSize"
          class="px-3 py-1 border border-gray-300 rounded text-sm"
        >
          <option value="10">10개</option>
          <option value="30">30개</option>
          <option value="50">50개</option>
          <option value="100">100개</option>
        </select>
      </div>

      <!-- 테이블 -->
      <div class="overflow-x-auto">
        <table class="w-full border-collapse text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="border border-gray-300 px-4 py-2 text-left">사이트</th>
              <th class="border border-gray-300 px-4 py-2 text-left">페이지</th>
              <th class="border border-gray-300 px-4 py-2 text-left">제목</th>
              <th class="border border-gray-300 px-4 py-2 text-left">등록일</th>
              <th class="border border-gray-300 px-4 py-2 text-left">수집일시</th>
              <th class="border border-gray-300 px-4 py-2 text-center">원본열기</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(row, index) in results" :key="`${row.site_name}-${row.page_id}-${row.real_seq}-${index}`">
              <tr class="border-b border-gray-200 hover:bg-blue-50 cursor-pointer">
                <td class="border border-gray-300 px-4 py-2">
                  <a
                    :href="row.site_url"
                    target="_blank"
                    rel="noopener noreferrer"
                    @click.stop
                    class="text-blue-500 hover:underline"
                  >
                    <span x-text="row.site_name"></span>
                  </a>
                </td>
                <td class="border border-gray-300 px-4 py-2">
                  <a
                    :href="row.detail_url"
                    target="_blank"
                    rel="noopener noreferrer"
                    @click.stop
                    class="text-blue-500 hover:underline"
                  >
                    <span x-text="row.page_id"></span>
                  </a>
                </td>
                <td class="border border-gray-300 px-4 py-2 max-w-xs truncate">
                  <span
                    class="cursor-pointer text-gray-700 hover:text-blue-500"
                    @click="selectRow(row, $el)"
                    :title="row.title"
                    x-text="row.title"
                  ></span>
                </td>
                <td class="border border-gray-300 px-4 py-2">
                  <span x-text="row.registration_date || '-'"></span>
                </td>
                <td class="border border-gray-300 px-4 py-2">
                  <span x-text="row.collection_date"></span>
                </td>
                <td class="border border-gray-300 px-4 py-2 text-center">
                  <a
                    :href="row.org_url"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-block px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors"
                    title="원본 사이트 열기"
                  >
                    <i class="bi bi-box-arrow-up-right"></i> 열기
                  </a>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <!-- 페이징 네비게이션 -->
      <div class="flex justify-center items-center gap-2 mt-6 flex-wrap">
        <!-- 이전 페이지 -->
        <button
          @click="goToPage(currentPage - 1)"
          :disabled="currentPage === 1"
          :class="currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'"
          class="px-3 py-1 border border-gray-300 rounded text-sm transition-colors"
        >
          ◀ 이전
        </button>

        <!-- 페이지 번호 -->
        <template x-for="page in paginationPages" :key="page">
          <button
            @click="goToPage(page)"
            :class="page === currentPage
              ? 'bg-blue-500 text-white'
              : 'border border-gray-300 hover:bg-gray-100'"
            class="px-3 py-1 rounded text-sm transition-colors"
            x-text="page"
          ></button>
        </template>

        <!-- 다음 페이지 -->
        <button
          @click="goToPage(currentPage + 1)"
          :disabled="currentPage >= totalPages"
          :class="currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'"
          class="px-3 py-1 border border-gray-300 rounded text-sm transition-colors"
        >
          다음 ▶
        </button>

        <!-- 페이지 정보 -->
        <span class="text-sm text-gray-600 ml-2">
          <span x-text="`${currentPage} / ${totalPages}`"></span>
        </span>
      </div>
    </div>

    <!-- 상세 정보 탭 -->
    <div x-show="activeResultTab === 'details' && selectedRow" class="space-y-4">
      <!-- 상세 정보 항목 -->
      <div class="space-y-3 mb-6">
        <div>
          <strong class="text-gray-700">사이트:</strong>
          <a
            :href="selectedRow.site_url"
            target="_blank"
            rel="noopener noreferrer"
            class="text-blue-500 hover:underline ml-2"
          >
            <span x-text="selectedRow.site_name"></span>
          </a>
        </div>
        <div>
          <strong class="text-gray-700">페이지:</strong>
          <a
            :href="selectedRow.detail_url"
            target="_blank"
            rel="noopener noreferrer"
            class="text-blue-500 hover:underline ml-2"
          >
            <span x-text="selectedRow.page_id"></span>
          </a>
        </div>
        <div>
          <strong class="text-gray-700">제목:</strong>
          <span class="ml-2" x-text="selectedRow.title"></span>
        </div>
        <div>
          <strong class="text-gray-700">등록일:</strong>
          <span class="ml-2" x-text="selectedRow.registration_date || '-'"></span>
        </div>
        <div>
          <strong class="text-gray-700">수집일시:</strong>
          <span class="ml-2" x-text="selectedRow.collection_date"></span>
        </div>
        <div class="flex items-center gap-3">
          <strong class="text-gray-700">링크:</strong>
          <a
            :href="selectedRow.org_url"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-block px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors"
          >
            <i class="bi bi-box-arrow-up-right"></i> 원본 사이트 열기
          </a>
          <button
            type="button"
            @click="activeResultTab = 'results'"
            class="inline-block px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition-colors"
          >
            <i class="bi bi-list"></i> 리스트로 돌아가기
          </button>
        </div>
      </div>

      <!-- 탭 네비게이션 -->
      <div class="border-b border-gray-200">
        <div class="flex gap-4">
          <button
            type="button"
            @click="activeTab = 'rendered'"
            :class="activeTab === 'rendered' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
            class="px-4 py-2 font-semibold transition-colors"
          >
            📄 렌더링 보기
          </button>
          <button
            type="button"
            @click="activeTab = 'html'"
            :class="activeTab === 'html' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
            class="px-4 py-2 font-semibold transition-colors"
          >
            🧾 HTML 코드 보기
          </button>
        </div>
      </div>

      <!-- 탭 콘텐츠 -->
      <div class="mt-4">
        <!-- 렌더링 보기 -->
        <div x-show="activeTab === 'rendered'" class="prose prose-sm max-w-none">
          <div x-html="selectedRow.summary"></div>
        </div>

        <!-- HTML 코드 보기 -->
        <div
          x-show="activeTab === 'html'"
          class="bg-gray-100 p-4 rounded-lg overflow-x-auto relative"
        >
          <button
            type="button"
            @click="copyToClipboard(selectedRow.summary)"
            class="absolute top-2 right-2 p-2 bg-white rounded hover:bg-gray-200 transition-colors"
            title="클립보드에 복사"
          >
            <i class="bi bi-clipboard-check text-gray-700"></i>
          </button>
          <pre
            class="text-xs text-gray-700 pr-10"
          ><code x-text="selectedRow.summary"></code></pre>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block script %}
<script>
  function searchData() {
    return {
      sites: [],
      selectedSites: [],
      selectAllSites: false,
      showSiteDropdown: false,
      keyword: "",
      results: [],
      selectedRow: null,
      searchPerformed: false,
      isLoading: false,
      activeTab: "rendered",
      activeResultTab: "results",
      pageSize: 10,
      currentPage: 1,
      totalCount: 0,

      get selectedSitesText() {
        if (this.selectedSites.length === 0) return "사이트 없음";
        if (this.selectedSites.length === this.sites.length)
          return "모든 사이트";
        const names = this.selectedSites.map((code) => {
          const site = this.sites.find((s) => s.code === code);
          return site ? site.name : code;
        });
        return (
          names.slice(0, 2).join(", ") +
          (names.length > 2 ? ` 외 ${names.length - 2}개` : "")
        );
      },

      init() {
        this.loadSites();
      },

      async loadSites() {
        try {
          const response = await fetch("/api/v1/search/sites");
          if (response.ok) {
            this.sites = await response.json();
            // 초기 상태: 모든 사이트 선택
            this.selectedSites = this.sites.map((s) => s.code);
            this.selectAllSites = true;
          }
        } catch (error) {
          console.error("사이트 로드 실패:", error);
        }
      },

      toggleSite(code) {
        const index = this.selectedSites.indexOf(code);
        if (index > -1) {
          this.selectedSites.splice(index, 1);
        } else {
          this.selectedSites.push(code);
        }
        this.selectAllSites = this.selectedSites.length === this.sites.length;
      },

      selectAllSitesClick() {
        // 모두선택 버튼 클릭
        this.selectedSites = this.sites.map((s) => s.code);
        this.selectAllSites = true;
      },

      deselectAllSites() {
        // 모두해제 버튼 클릭
        this.selectedSites = [];
        this.selectAllSites = false;
      },

      toggleAllSites() {
        // (레거시) 이전의 토글 함수
        if (this.selectAllSites) {
          this.selectedSites = this.sites.map((s) => s.code);
        } else {
          this.selectedSites = [];
        }
      },

      async performSearch() {
        // 사이트 선택 검증
        if (this.selectedSites.length === 0) {
          alert("최소 1개 이상의 사이트를 선택해주세요.");
          return;
        }

        // 검색 시작 시 이전 선택 CSS 제거
        document.querySelectorAll('.css_title_blue').forEach((el) => {
          el.classList.remove('css_title_blue');
        });

        // 검색결과 탭으로 전환
        this.activeResultTab = "results";

        this.isLoading = true;
        this.searchPerformed = true;
        try {
          // selectedSites가 비어있으면 모든 사이트 (빈 문자열 전송)
          // selectedSites가 있으면 해당 사이트들만 선택
          const sitesParam = this.selectedSites.join(",");
          const response = await fetch(
            `/api/v1/search/results?sites=${encodeURIComponent(
              sitesParam
            )}&keyword=${encodeURIComponent(this.keyword)}&page=${this.currentPage}&pagesize=${this.pageSize}`
          );
          if (response.ok) {
            const data = await response.json();
            this.results = data.items || [];
            this.totalCount = data.total || 0;
            this.currentPage = data.page || 1;
            this.selectedRow = null;
          }
        } catch (error) {
          console.error("검색 실패:", error);
          this.results = [];
        } finally {
          this.isLoading = false;
        }
      },

      formatNumber(value) {
        return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      },

      resetSearch() {
        // 선택 CSS 제거
        document.querySelectorAll('.css_title_blue').forEach((el) => {
          el.classList.remove('css_title_blue');
        });

        this.keyword = "";
        // 초기 상태로 복원: 모든 사이트 선택
        this.selectedSites = this.sites.map((s) => s.code);
        this.selectAllSites = true;
        this.results = [];
        this.selectedRow = null;
        this.searchPerformed = false;
        this.currentPage = 1;
        this.pageSize = 10;
      },

      selectRow(row, titleElement) {
        // 1. 모든 제목에서 css_title_blue 클래스 제거
        document.querySelectorAll('.css_title_blue').forEach((el) => {
          el.classList.remove('css_title_blue');
        });

        // 2. 현재 클릭한 제목에만 css_title_blue 추가
        if (titleElement) {
          titleElement.classList.add('css_title_blue');
        }

        // 3. 상세정보 가져오기
        this.selectedRow = row;
        this.activeTab = "rendered";
        this.activeResultTab = "details";
      },

      isRowSelected(row) {
        // 현재 선택된 행인지 확인
        if (!this.selectedRow) return false;
        return (
          this.selectedRow.site_name === row.site_name &&
          this.selectedRow.page_id === row.page_id &&
          this.selectedRow.real_seq === row.real_seq
        );
      },

      changePageSize(size) {
        this.pageSize = size;
        this.currentPage = 1;
        this.performSearch();
      },

      goToPage(page) {
        this.currentPage = page;
        this.performSearch();
      },

      copyToClipboard(text) {
        // 클립보드에 텍스트 복사
        navigator.clipboard.writeText(text).then(() => {
          alert("클립보드에 복사되었습니다!");
        }).catch(err => {
          console.error("복사 실패:", err);
          alert("복사에 실패했습니다.");
        });
      },

      get totalPages() {
        return Math.ceil(this.totalCount / this.pageSize);
      },

      get paginationPages() {
        const pages = [];
        const maxVisible = 5;
        let start = Math.max(1, this.currentPage - Math.floor(maxVisible / 2));
        let end = Math.min(this.totalPages, start + maxVisible - 1);

        if (end - start + 1 < maxVisible) {
          start = Math.max(1, end - maxVisible + 1);
        }

        for (let i = start; i <= end; i++) {
          pages.push(i);
        }
        return pages;
      },
    };
  }
</script>
{% endblock %}
