{% extends "common/base.html" %}

{% block style %}
<style>
  .search-card {
    @apply bg-white border border-gray-200 rounded-lg p-6 shadow-sm;
  }

  .filter-group {
    @apply space-y-3;
  }
</style>
{% endblock %}

{% block content %}
<div x-data="searchData()">
  <!-- í˜ì´ì§€ ì œëª© -->
  <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ” ë°ì´í„° ì¡°íšŒ</h1>
  <p class="text-gray-600 mb-6">í‚¤ì›Œë“œë¡œ ë²•ê·œ ë°ì´í„°ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤</p>

  <!-- ê²€ìƒ‰ í•„í„° -->
  <div class="search-card mb-6">
    <h2 class="text-xl font-bold text-gray-800 mb-4">ê²€ìƒ‰ ì˜µì…˜</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- ì‚¬ì´íŠ¸ ì„ íƒ -->
      <div class="filter-group">
        <label class="block text-sm font-semibold text-gray-700 mb-2">ì‚¬ì´íŠ¸ ì„ íƒ</label>
        <div class="relative">
          <button
            @click="showSiteDropdown = !showSiteDropdown"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg text-left bg-white hover:border-blue-500 flex justify-between items-center"
          >
            <span x-text="selectedSitesText || 'ëª¨ë“  ì‚¬ì´íŠ¸'"></span>
            <i class="bi bi-chevron-down text-gray-500"></i>
          </button>

          <!-- ë“œë¡­ë‹¤ìš´ -->
          <div
            x-show="showSiteDropdown"
            @click.outside="showSiteDropdown = false"
            class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 max-h-48 overflow-y-auto"
          >
            <button
              @click="toggleAllSites()"
              class="w-full px-4 py-2 text-left hover:bg-blue-100 border-b font-semibold text-sm"
            >
              <input type="checkbox" x-model="selectAllSites" class="mr-2">
              ëª¨ë“  ì‚¬ì´íŠ¸
            </button>
            <template x-for="site in sites" :key="site.code">
              <button
                @click="toggleSite(site.code)"
                class="w-full px-4 py-2 text-left hover:bg-blue-100 text-sm block"
              >
                <input
                  type="checkbox"
                  :checked="selectedSites.includes(site.code)"
                  class="mr-2"
                >
                <span x-text="`${site.name} (${site.code})`"></span>
              </button>
            </template>
          </div>
        </div>
        <p class="text-xs text-gray-500 mt-1">ì—¬ëŸ¬ ì‚¬ì´íŠ¸ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
      </div>

      <!-- ê²€ìƒ‰ í‚¤ì›Œë“œ -->
      <div class="filter-group md:col-span-2">
        <label class="block text-sm font-semibold text-gray-700 mb-2">ê²€ìƒ‰ í‚¤ì›Œë“œ</label>
        <input
          type="text"
          x-model="keyword"
          @keydown.enter="performSearch()"
          placeholder="ì œëª©ì´ë‚˜ ë‚´ìš©ì—ì„œ ê²€ìƒ‰í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
        />
      </div>
    </div>

    <!-- ë²„íŠ¼ -->
    <div class="flex gap-2 mt-6">
      <button
        @click="performSearch()"
        class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2"
      >
        <i class="bi bi-search"></i>
        ğŸ” ê²€ìƒ‰
      </button>
      <button
        @click="resetSearch()"
        class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors flex items-center gap-2"
      >
        <i class="bi bi-arrow-clockwise"></i>
        ğŸ”„ ì´ˆê¸°í™”
      </button>
    </div>
  </div>

  <!-- ê²€ìƒ‰ ê²°ê³¼ -->
  <div x-show="searchPerformed" class="search-card">
    <h2 class="text-xl font-bold text-gray-800 mb-4">
      ğŸ“‹ ê²€ìƒ‰ ê²°ê³¼
      <span class="text-blue-600" x-text="`(${results.length}ê±´)`"></span>
    </h2>

    <!-- ë¡œë”© ìƒíƒœ -->
    <div x-show="isLoading" class="text-center py-8">
      <i class="bi bi-hourglass text-2xl text-blue-500"></i>
      <p class="text-gray-600 mt-2">ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <!-- ê²°ê³¼ ì—†ìŒ -->
    <div x-show="!isLoading && results.length === 0" class="text-center py-8 text-blue-600">
      <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>

    <!-- ê²°ê³¼ í…Œì´ë¸” -->
    <div x-show="!isLoading && results.length > 0" class="overflow-x-auto">
      <table class="w-full border-collapse text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="border border-gray-300 px-4 py-2 text-left">ì‚¬ì´íŠ¸</th>
            <th class="border border-gray-300 px-4 py-2 text-left">í˜ì´ì§€</th>
            <th class="border border-gray-300 px-4 py-2 text-left">ì œëª©</th>
            <th class="border border-gray-300 px-4 py-2 text-left">ë“±ë¡ì¼</th>
            <th class="border border-gray-300 px-4 py-2 text-left">ìˆ˜ì§‘ì¼ì‹œ</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="row in results" :key="row.page_id">
            <tr
              class="border-b border-gray-200 hover:bg-blue-50 cursor-pointer"
              @click="selectRow(row)"
            >
              <td class="border border-gray-300 px-4 py-2">
                <a :href="row.site_url" target="_blank" class="text-blue-500 hover:underline">
                  <span x-text="row.site_name"></span>
                </a>
              </td>
              <td class="border border-gray-300 px-4 py-2">
                <a :href="row.detail_url" target="_blank" class="text-blue-500 hover:underline">
                  <span x-text="row.page_id"></span>
                </a>
              </td>
              <td class="border border-gray-300 px-4 py-2 max-w-xs truncate">
                <a :href="row.org_url" target="_blank" class="text-blue-500 hover:underline">
                  <span x-text="row.title"></span>
                </a>
              </td>
              <td class="border border-gray-300 px-4 py-2">
                <span x-text="row.registration_date || '-'"></span>
              </td>
              <td class="border border-gray-300 px-4 py-2">
                <span x-text="row.collection_date"></span>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ìƒì„¸ ì •ë³´ (í–‰ ì„ íƒ ì‹œ) -->
  <div x-show="selectedRow" class="bg-white rounded-lg shadow-sm p-6 mt-6">
    <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“„ ì„ íƒëœ í•­ëª© ìƒì„¸ ì •ë³´</h2>

    <div x-show="selectedRow" class="space-y-3 mb-6">
      <div>
        <strong class="text-gray-700">ì‚¬ì´íŠ¸:</strong>
        <a :href="selectedRow.site_url" target="_blank" class="text-blue-500 hover:underline ml-2">
          <span x-text="selectedRow.site_name"></span>
        </a>
      </div>
      <div>
        <strong class="text-gray-700">í˜ì´ì§€:</strong>
        <a :href="selectedRow.detail_url" target="_blank" class="text-blue-500 hover:underline ml-2">
          <span x-text="selectedRow.page_id"></span>
        </a>
      </div>
      <div>
        <strong class="text-gray-700">ì œëª©:</strong>
        <a :href="selectedRow.org_url" target="_blank" class="text-blue-500 hover:underline ml-2">
          <span x-text="selectedRow.title"></span>
        </a>
      </div>
      <div>
        <strong class="text-gray-700">ë“±ë¡ì¼:</strong>
        <span class="ml-2" x-text="selectedRow.registration_date || '-'"></span>
      </div>
      <div>
        <strong class="text-gray-700">ìˆ˜ì§‘ì¼ì‹œ:</strong>
        <span class="ml-2" x-text="selectedRow.collection_date"></span>
      </div>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="border-b border-gray-200">
      <div class="flex gap-4">
        <button
          @click="activeTab = 'rendered'"
          :class="activeTab === 'rendered' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
          class="px-4 py-2 font-semibold transition-colors"
        >
          ğŸ“„ ë Œë”ë§ ë³´ê¸°
        </button>
        <button
          @click="activeTab = 'html'"
          :class="activeTab === 'html' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
          class="px-4 py-2 font-semibold transition-colors"
        >
          ğŸ§¾ HTML ì½”ë“œ ë³´ê¸°
        </button>
      </div>
    </div>

    <!-- íƒ­ ì½˜í…ì¸  -->
    <div class="mt-4">
      <!-- ë Œë”ë§ ë³´ê¸° -->
      <div x-show="activeTab === 'rendered'" class="prose prose-sm max-w-none">
        <div x-html="selectedRow.summary"></div>
      </div>

      <!-- HTML ì½”ë“œ ë³´ê¸° -->
      <div x-show="activeTab === 'html'" class="bg-gray-100 p-4 rounded-lg overflow-x-auto">
        <pre class="text-xs text-gray-700"><code x-text="selectedRow.summary"></code></pre>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
  function searchData() {
    return {
      sites: [],
      selectedSites: [],
      selectAllSites: false,
      showSiteDropdown: false,
      keyword: '',
      results: [],
      selectedRow: null,
      searchPerformed: false,
      isLoading: false,
      activeTab: 'rendered',

      get selectedSitesText() {
        if (this.selectedSites.length === 0) return '';
        if (this.selectedSites.length === this.sites.length) return 'ëª¨ë“  ì‚¬ì´íŠ¸';
        const names = this.selectedSites.map(code => {
          const site = this.sites.find(s => s.code === code);
          return site ? site.name : code;
        });
        return names.slice(0, 2).join(', ') + (names.length > 2 ? ` ì™¸ ${names.length - 2}ê°œ` : '');
      },

      init() {
        this.loadSites();
      },

      async loadSites() {
        try {
          const response = await fetch('/api/v1/search/sites');
          if (response.ok) {
            this.sites = await response.json();
          }
        } catch (error) {
          console.error('ì‚¬ì´íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      },

      toggleSite(code) {
        const index = this.selectedSites.indexOf(code);
        if (index > -1) {
          this.selectedSites.splice(index, 1);
        } else {
          this.selectedSites.push(code);
        }
        this.selectAllSites = this.selectedSites.length === this.sites.length;
      },

      toggleAllSites() {
        if (this.selectAllSites) {
          this.selectedSites = this.sites.map(s => s.code);
        } else {
          this.selectedSites = [];
        }
      },

      async performSearch() {
        if (!this.keyword.trim()) {
          alert('ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
          return;
        }

        this.isLoading = true;
        try {
          const sitesParam = this.selectedSites.join(',');
          const response = await fetch(
            `/api/v1/search/results?sites=${encodeURIComponent(sitesParam)}&keyword=${encodeURIComponent(this.keyword)}`
          );
          if (response.ok) {
            this.results = await response.json();
            this.selectedRow = null;
          }
        } catch (error) {
          console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', error);
          this.results = [];
        } finally {
          this.searchPerformed = true;
          this.isLoading = false;
        }
      },

      resetSearch() {
        this.keyword = '';
        this.selectedSites = [];
        this.selectAllSites = false;
        this.results = [];
        this.selectedRow = null;
        this.searchPerformed = false;
      },

      selectRow(row) {
        this.selectedRow = row;
        this.activeTab = 'rendered';
      }
    };
  }
</script>
{% endblock %}
