{% extends "common/base.html" %} {% block style %}
<style>
  .chart-container {
    background-color: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1.5rem;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    margin-bottom: 1.5rem;
  }

  .stat-card {
    background-color: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #1f2937;
  }

  .stat-label {
    font-size: 0.875rem;
    color: #4b5563;
    margin-top: 0.25rem;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  thead {
    background-color: #f3f4f6;
  }

  th,
  td {
    border: 1px solid #d1d5db;
    padding: 0.5rem 1rem;
  }

  th {
    text-align: left;
  }

  td.number {
    text-align: right;
  }

  tbody tr:hover {
    background-color: #eff6ff;
  }
</style>
{% endblock %} {% block content %}
<div x-data="statisticsData()" class="max-w-7xl mx-auto px-4">
  <!-- í˜ì´ì§€ ì œëª© -->
  <div class="flex items-baseline gap-3 mb-6">
    <h1 class="text-3xl font-bold text-gray-800">ğŸ“ˆ í†µê³„ ë¶„ì„</h1>
    <span class="text-base text-gray-600">ë²•ê·œê´€ë ¨ ë°ì´í„°ìˆ˜ì§‘ í†µê³„</span>
    <span
      x-show="collectionPeriod.first_date && collectionPeriod.last_date"
      class="text-sm text-gray-500"
      x-text="`(${collectionPeriod.first_date} ~ ${collectionPeriod.last_date})`"
    ></span>
  </div>

  <!-- ì£¼ìš” ì§€í‘œ ì¹´ë“œ (ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼) -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 mb-3">
    <!-- ì „ì²´ ìˆ˜ì§‘ ì‚¬ì´íŠ¸ -->
    <div
      class="bg-white border-l-4 border-blue-400 shadow hover:shadow-md transition-shadow rounded-lg p-4"
    >
      <div class="text-gray-500 text-xs font-semibold uppercase">
        ì „ì²´ ìˆ˜ì§‘ ì‚¬ì´íŠ¸
      </div>
      <div
        class="text-2xl font-bold text-blue-600 mt-1"
        x-text="formatNumber(metrics.total_sites) || '0'"
      ></div>
    </div>

    <!-- ì „ì²´ ìˆ˜ì§‘ í˜ì´ì§€ -->
    <div
      class="bg-white border-l-4 border-blue-400 shadow hover:shadow-md transition-shadow rounded-lg p-4"
    >
      <div class="text-gray-500 text-xs font-semibold uppercase">
        ì „ì²´ ìˆ˜ì§‘ í˜ì´ì§€
      </div>
      <div
        class="text-2xl font-bold text-blue-600 mt-1"
        x-text="formatNumber(metrics.total_pages) || '0'"
      ></div>
    </div>

    <!-- ì „ì²´ ê²Œì‹œë¬¼ ê°¯ìˆ˜ -->
    <div
      class="bg-white border-l-4 border-blue-400 shadow hover:shadow-md transition-shadow rounded-lg p-4"
    >
      <div class="text-gray-500 text-xs font-semibold uppercase">
        ì „ì²´ ê²Œì‹œë¬¼ ê°¯ìˆ˜
      </div>
      <div
        class="text-2xl font-bold text-blue-600 mt-1"
        x-text="formatNumber(metrics.total_posts) || '0'"
      ></div>
    </div>

    <!-- ì „ì²´ ì²¨ë¶€íŒŒì¼ ê°¯ìˆ˜ -->
    <div
      class="bg-white border-l-4 border-blue-400 shadow hover:shadow-md transition-shadow rounded-lg p-4"
    >
      <div class="text-gray-500 text-xs font-semibold uppercase">
        ì „ì²´ ì²¨ë¶€íŒŒì¼ ê°¯ìˆ˜
      </div>
      <div
        class="text-2xl font-bold text-blue-600 mt-1"
        x-text="formatNumber(metrics.total_attachments) || '0'"
      ></div>
    </div>
  </div>

  <hr class="my-3" />

  <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="bg-white border-b border-gray-200 mb-6">
    <div class="flex gap-4">
      <button
        @click="activeTab = 'chart'"
        :class="activeTab === 'chart' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
        class="px-4 py-3 font-semibold transition-colors"
      >
        ğŸ“ˆ ìˆ˜ì§‘ í†µê³„
      </button>
      <button
        @click="activeTab = 'detail'"
        :class="activeTab === 'detail' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
        class="px-4 py-3 font-semibold transition-colors"
      >
        ğŸ¢ ìƒì„¸í†µê³„í‘œ
      </button>
    </div>
  </div>

  <!-- íƒ­ 1: ìˆ˜ì§‘ í†µê³„ -->
  <div x-show="activeTab === 'chart'">
    <!-- ì°¨íŠ¸ ì˜ì—­ -->
    <div class="chart-container">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">
          ğŸ“Š ì‚¬ì´íŠ¸ë³„ ìˆ˜ì§‘ í†µê³„ ì°¨íŠ¸
        </h2>
        <button
          aria-label="ì± íŠ¸ì ‘ê¸°í¼ì¹˜ê¸°"
          @click="showChart = !showChart"
          class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          :title="showChart ? 'ì°¨íŠ¸ ì ‘ê¸°' : 'ì°¨íŠ¸ í¼ì¹˜ê¸°'"
        >
          <i
            :class="showChart ? 'bi bi-chevron-up' : 'bi bi-chevron-down'"
            class="text-gray-600 text-lg"
          ></i>
        </button>
      </div>
      <div x-show="showChart" x-transition>
        <canvas id="sitesChart" class="max-h-96"></canvas>
      </div>
    </div>

    <!-- í…Œì´ë¸” -->
    <div
      class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 overflow-hidden"
    >
      <div class="px-6 py-4 border-b border-gray-100">
        <h2 class="text-xl font-bold text-gray-800">ğŸ“‹ ì‚¬ì´íŠ¸ë³„ í†µê³„ í…Œì´ë¸”</h2>
      </div>

      <!-- íˆ´ë°” -->
      <div
        class="px-6 py-4 bg-gray-50 flex flex-col md:flex-row gap-3 md:items-end"
      >
        <!-- ì‚¬ì´íŠ¸ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
        <div class="flex-1 relative">
          <label class="block text-sm font-semibold text-gray-700 mb-2"
            >ì‚¬ì´íŠ¸ ì„ íƒ</label
          >

          <!-- ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ -->
          <button
            aria-label="ë“œë¡­ë‹¤ìš´"
            @click="showSiteDropdown = !showSiteDropdown"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-left bg-white hover:border-blue-500 flex justify-between items-center text-sm transition-colors"
          >
            <span x-text="selectedSitesText"></span>
            <i
              :class="showSiteDropdown ? 'bi bi-chevron-up' : 'bi bi-chevron-down'"
              class="text-gray-500"
            ></i>
          </button>

          <!-- ë“œë¡­ë‹¤ìš´ íŒ¨ë„ -->
          <div
            x-show="showSiteDropdown"
            @click.outside="showSiteDropdown = false"
            class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-xl shadow-lg z-50"
          >
            <!-- ëª¨ë‘ì„ íƒ/í•´ì œ ë²„íŠ¼ -->
            <div
              class="sticky top-0 bg-white px-3 py-2 border-b border-gray-200 flex gap-2"
            >
              <button
                @click="selectAllSites()"
                class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors"
              >
                ëª¨ë‘ì„ íƒ
              </button>
              <button
                @click="deselectAllSites()"
                class="px-3 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 transition-colors"
              >
                ëª¨ë‘í•´ì œ
              </button>
              <span class="text-xs text-gray-600 ml-auto self-center">
                <span
                  x-text="`${selectedSiteNames.length}/${allSiteNames.length}`"
                ></span>
              </span>
            </div>

            <!-- ì‚¬ì´íŠ¸ ì²´í¬ë°•ìŠ¤ ê·¸ë¦¬ë“œ (3ì—´) -->
            <div class="px-3 py-2 grid grid-cols-3 gap-x-2 gap-y-1">
              <template x-for="site in allSiteNames" :key="site">
                <label
                  class="flex items-center px-2 py-1 rounded hover:bg-blue-50 cursor-pointer text-xs"
                >
                  <input
                    type="checkbox"
                    @change="toggleSiteSelection(site)"
                    :checked="selectedSiteNames.includes(site)"
                    class="w-4 h-4 rounded cursor-pointer"
                  />
                  <span
                    class="ml-2 text-gray-700 truncate"
                    :title="site"
                    x-text="site"
                  ></span>
                </label>
              </template>
            </div>
          </div>
        </div>

        <!-- ì •ë ¬ ë²„íŠ¼ -->
        <div class="flex gap-2">
          <button
            @click="toggleSort('count')"
            class="rounded-xl bg-white px-4 py-2.5 text-sm shadow-sm ring-1 ring-gray-200 hover:bg-gray-50"
          >
            ê²Œì‹œê¸€ìˆ˜ ì •ë ¬
          </button>
          <button
            @click="toggleSort('file_count')"
            class="rounded-xl bg-white px-4 py-2.5 text-sm shadow-sm ring-1 ring-gray-200 hover:bg-gray-50"
          >
            ì²¨ë¶€íŒŒì¼ìˆ˜ ì •ë ¬
          </button>
          <button
            @click="resetFilter()"
            class="rounded-xl bg-gray-900 px-4 py-2.5 text-sm text-white shadow-sm hover:bg-black/90"
          >
            ì´ˆê¸°í™”
          </button>
          <button
            @click="exportSiteStatsToExcel()"
            class="rounded-xl bg-green-500 px-4 py-2.5 text-sm text-white shadow-sm hover:bg-green-600 flex items-center gap-2"
            title="ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ"
          >
            <i class="bi bi-file-earmark-excel"></i>
            <span>ì—‘ì…€</span>
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100/80 text-gray-700">
            <tr>
              <th class="px-4 py-3 text-left font-semibold">ì‚¬ì´íŠ¸</th>
              <th class="px-4 py-3 text-right font-semibold">ê²Œì‹œê¸€ìˆ˜</th>
              <th class="px-4 py-3 text-right font-semibold">ì²¨ë¶€íŒŒì¼ìˆ˜</th>
              <th class="px-4 py-3 text-left font-semibold">ì‹œê°í™”</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <template x-for="row in filteredStats" :key="row.site">
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3">
                  <div class="font-medium" x-text="row.site"></div>
                </td>
                <td
                  class="px-4 py-3 text-right tabular-nums"
                  x-text="formatNumber(row.count) || '0'"
                ></td>
                <td
                  class="px-4 py-3 text-right tabular-nums"
                  x-text="formatNumber(row.file_count) || '0'"
                ></td>
                <td class="px-4 py-3">
                  <div class="flex items-center gap-3">
                    <div class="w-40">
                      <div class="text-[10px] text-gray-500 mb-1">ê²Œì‹œê¸€</div>
                      <div class="h-2 bg-blue-100 rounded-full overflow-hidden">
                        <div
                          class="h-full bg-blue-500"
                          :style="`width: ${getBarWidth(row.count, maxPosts)}%`"
                        ></div>
                      </div>
                    </div>
                    <div class="w-40">
                      <div class="text-[10px] text-gray-500 mb-1">ì²¨ë¶€</div>
                      <div
                        class="h-2 bg-green-100 rounded-full overflow-hidden"
                      >
                        <div
                          class="h-full bg-green-500"
                          :style="`width: ${getBarWidth(row.file_count, maxFiles)}%`"
                        ></div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div
        class="flex items-center justify-between px-4 py-3 bg-gray-50 text-xs text-gray-500"
      >
        <span
          x-text="`í‘œì‹œ: ${formatNumber(filteredStats.length)}ê°œ ì‚¬ì´íŠ¸`"
        ></span>
        <span
          >Tip: í—¤ë” ë²„íŠ¼ìœ¼ë¡œ ì •ë ¬í•˜ê³ , ìƒë‹¨ ì…ë ¥ì°½ìœ¼ë¡œ ë¹ ë¥´ê²Œ
          í•„í„°ë§í•˜ì„¸ìš”.</span
        >
      </div>
    </div>
  </div>

  <!-- íƒ­ 2: ìƒì„¸í†µê³„í‘œ -->
  <div x-show="activeTab === 'detail'">
    <!-- ìƒì„¸ í…Œì´ë¸” -->
    <div
      class="bg-white rounded-2xl shadow-sm ring-1 ring-gray-200 overflow-hidden"
    >
      <div
        class="px-6 py-4 border-b border-gray-100 flex justify-between items-center"
      >
        <h2 class="text-xl font-bold text-gray-800">
          ğŸ“Š ì‚¬ì´íŠ¸Â·í˜ì´ì§€ë³„ ê²Œì‹œê¸€ ìˆ˜ ë° ì²¨ë¶€íŒŒì¼ ìˆ˜
        </h2>
        <button
          @click="exportToExcel()"
          class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2 text-sm"
          title="ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ"
        >
          <i class="bi bi-file-earmark-excel"></i>
          <span>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</span>
        </button>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100/80 text-gray-700">
            <tr>
              <th class="px-4 py-3 text-left font-semibold">ì‚¬ì´íŠ¸</th>
              <th class="px-4 py-3 text-left font-semibold">í˜ì´ì§€</th>
              <th class="px-4 py-3 text-right font-semibold">ê²Œì‹œê¸€ìˆ˜</th>
              <th class="px-4 py-3 text-right font-semibold">ì²¨ë¶€íŒŒì¼ìˆ˜</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <template
              x-for="(row, index) in detailStats"
              :key="`${row.site}-${row.page}-${index}`"
            >
              <tr
                :class="getSiteGroupClass(row.site, index)"
                class="hover:bg-blue-50 transition-colors"
              >
                <!-- ì‚¬ì´íŠ¸ëª…: ì²« ë²ˆì§¸ í–‰ì—ë§Œ í‘œì‹œ (rowspan ì‚¬ìš©) -->
                <td
                  x-show="shouldShowSite(row.site, index)"
                  :rowspan="getSiteRowspan(row.site)"
                  class="px-4 py-3 align-middle border-r border-gray-200"
                >
                  <div class="font-bold text-gray-800" x-text="row.site"></div>
                </td>

                <td class="px-4 py-3 text-gray-600" x-text="row.page"></td>
                <td
                  class="px-4 py-3 text-right tabular-nums"
                  x-text="formatNumber(row.posts) || '0'"
                ></td>
                <td
                  class="px-4 py-3 text-right tabular-nums"
                  x-text="formatNumber(row.files) || '0'"
                ></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div
        class="flex items-center justify-between px-4 py-3 bg-gray-50 text-xs text-gray-500"
      >
        <span
          x-text="`í‘œì‹œ: ${formatNumber(detailStats.length)}ê°œ í˜ì´ì§€`"
        ></span>
        <span>ì‚¬ì´íŠ¸ë³„Â·í˜ì´ì§€ë³„ ìƒì„¸ í†µê³„</span>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block script %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
  function statisticsData() {
    return {
      activeTab: "chart",
      metrics: {
        total_sites: 0,
        total_pages: 0,
        total_posts: 0,
        total_attachments: 0,
      },
      siteStats: [],
      filteredStats: [],
      detailStats: [],
      chart: null,
      sortKey: null,
      sortDir: "desc",
      maxPosts: 0,
      maxFiles: 0,
      showSiteDropdown: false,
      allSiteNames: [],
      selectedSiteNames: [],
      collectionPeriod: {
        first_date: null,
        last_date: null,
      },
      showChart: true,

      get selectedSitesText() {
        if (this.selectedSiteNames.length === 0) {
          return "ì‚¬ì´íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”";
        }
        if (this.selectedSiteNames.length === this.allSiteNames.length) {
          return "ëª¨ë“  ì‚¬ì´íŠ¸";
        }
        if (this.selectedSiteNames.length === 1) {
          return this.selectedSiteNames[0];
        }
        return `${this.selectedSiteNames[0]} ì™¸ ${
          this.selectedSiteNames.length - 1
        }ê°œ`;
      },

      async init() {
        console.log("âœ… statisticsData ì´ˆê¸°í™”");
        await this.loadCollectionPeriod();
        await this.loadMetrics();
        await this.loadSiteStats();
        await this.loadDetailStats();

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        await this.$nextTick(() => {
          this.initChart();
        });
      },

      async loadCollectionPeriod() {
        try {
          const response = await fetch("/api/v1/statistics/collection-period");
          if (response.ok) {
            this.collectionPeriod = await response.json();
            console.log("ğŸ“… ìˆ˜ì§‘ ê¸°ê°„ ë¡œë“œ ì™„ë£Œ:", this.collectionPeriod);
          }
        } catch (error) {
          console.error("ìˆ˜ì§‘ ê¸°ê°„ ë¡œë“œ ì‹¤íŒ¨:", error);
        }
      },

      async loadMetrics() {
        try {
          const response = await fetch("/api/v1/statistics/metrics");
          if (response.ok) {
            this.metrics = await response.json();
            console.log("ğŸ“Š ë©”íŠ¸ë¦­ ë¡œë“œ ì™„ë£Œ:", this.metrics);
          }
        } catch (error) {
          console.error("ë©”íŠ¸ë¦­ ë¡œë“œ ì‹¤íŒ¨:", error);
        }
      },

      async loadSiteStats() {
        try {
          const sitesResponse = await fetch("/api/v1/statistics/sites");
          const filesResponse = await fetch("/api/v1/statistics/files");

          if (sitesResponse.ok && filesResponse.ok) {
            const sites = await sitesResponse.json();
            const files = await filesResponse.json();

            // ë°ì´í„° ë³‘í•©
            this.siteStats = sites.map((s) => {
              const fileData = files.find((f) => f.site === s.site);
              return {
                ...s,
                file_count: fileData ? fileData.file_count : 0,
              };
            });

            // ìµœëŒ€ê°’ ê³„ì‚°
            this.maxPosts = Math.max(...this.siteStats.map((s) => s.count));
            this.maxFiles = Math.max(
              ...this.siteStats.map((s) => s.file_count)
            );

            // ì‚¬ì´íŠ¸ ëª©ë¡ ì¶”ì¶œ ë° ëª¨ë‘ ì„ íƒ
            this.allSiteNames = [
              ...new Set(this.siteStats.map((s) => s.site)),
            ].sort();
            this.selectedSiteNames = [...this.allSiteNames];

            // ì´ˆê¸° í•„í„°ë§
            this.filterAndSort();
          }
        } catch (error) {
          console.error("ì‚¬ì´íŠ¸ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:", error);
        }
      },

      async loadDetailStats() {
        try {
          const response = await fetch("/api/v1/statistics/detail");
          if (response.ok) {
            this.detailStats = await response.json();
          }
        } catch (error) {
          console.error("ìƒì„¸ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:", error);
        }
      },

      initChart() {
        const canvas = document.getElementById("sitesChart");
        if (!canvas || this.siteStats.length === 0) return;

        const ctx = canvas.getContext("2d");

        const labels = this.siteStats.map((s) => s.site);
        const data = this.siteStats.map((s) => s.count);

        this.chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "ê²Œì‹œê¸€ìˆ˜",
                data: data,
                backgroundColor: "#3b82f6",
                borderColor: "#1e40af",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 10,
                },
              },
            },
          },
        });
      },

      formatNumber(value) {
        if (!value && value !== 0) return value;

        // ìˆ«ì ê°’ ì²˜ë¦¬
        if (typeof value === "number") {
          return value.toLocaleString("en-US");
        }

        // ë¬¸ìì—´ ê°’ ì²˜ë¦¬
        if (typeof value === "string") {
          const num = parseInt(value);
          if (!isNaN(num)) {
            return num.toLocaleString("en-US");
          }
        }

        return value;
      },

      filterAndSort() {
        let data = [...this.siteStats];

        // ì„ íƒëœ ì‚¬ì´íŠ¸ë¡œ í•„í„°ë§
        if (
          this.selectedSiteNames.length > 0 &&
          this.selectedSiteNames.length < this.allSiteNames.length
        ) {
          data = data.filter((d) => this.selectedSiteNames.includes(d.site));
        }

        // ì •ë ¬
        if (this.sortKey) {
          data.sort((a, b) => {
            const v = a[this.sortKey] - b[this.sortKey];
            return this.sortDir === "asc" ? v : -v;
          });
        }

        this.filteredStats = data;
      },

      toggleSort(key) {
        if (this.sortKey === key) {
          this.sortDir = this.sortDir === "asc" ? "desc" : "asc";
        } else {
          this.sortKey = key;
          this.sortDir = "desc";
        }
        this.filterAndSort();
      },

      resetFilter() {
        this.selectedSiteNames = [...this.allSiteNames];
        this.sortKey = null;
        this.sortDir = "desc";
        this.showSiteDropdown = false;
        this.filterAndSort();
      },

      toggleSiteSelection(site) {
        const index = this.selectedSiteNames.indexOf(site);
        if (index > -1) {
          this.selectedSiteNames.splice(index, 1);
        } else {
          this.selectedSiteNames.push(site);
        }
        this.filterAndSort();
      },

      selectAllSites() {
        this.selectedSiteNames = [...this.allSiteNames];
        this.filterAndSort();
      },

      deselectAllSites() {
        this.selectedSiteNames = [];
        this.filterAndSort();
      },

      getBarWidth(value, max) {
        if (!max || max === 0) return 0;
        return Math.round((value / max) * 100);
      },

      getSiteGroupClass(site, index) {
        // í˜„ì¬ í–‰ì˜ ì‚¬ì´íŠ¸ì™€ ì´ì „ í–‰ì˜ ì‚¬ì´íŠ¸ê°€ ë‹¤ë¥´ë©´ ê·¸ë£¹ ë³€ê²½
        if (index === 0) {
          this._lastSite = site;
          this._siteGroupIndex = 0;
          return this._siteGroupIndex % 2 === 0 ? "bg-yellow-50" : "bg-white";
        }

        const prevSite = this.detailStats[index - 1]?.site;
        if (prevSite !== site) {
          this._lastSite = site;
          this._siteGroupIndex = (this._siteGroupIndex || 0) + 1;
        }

        return this._siteGroupIndex % 2 === 0 ? "bg-yellow-50" : "bg-white";
      },

      shouldShowSite(site, index) {
        // ì²« ë²ˆì§¸ í–‰ì´ê±°ë‚˜, ì´ì „ í–‰ê³¼ ì‚¬ì´íŠ¸ê°€ ë‹¤ë¥´ë©´ ì‚¬ì´íŠ¸ëª… í‘œì‹œ
        if (index === 0) return true;
        const prevSite = this.detailStats[index - 1]?.site;
        return prevSite !== site;
      },

      getSiteRowspan(site) {
        // í•´ë‹¹ ì‚¬ì´íŠ¸ì˜ í˜ì´ì§€ ê°œìˆ˜ ê³„ì‚°
        return this.detailStats.filter((row) => row.site === site).length;
      },

      exportSiteStatsToExcel() {
        try {
          console.log("ğŸ“¥ ì‚¬ì´íŠ¸ë³„ í†µê³„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œì‘...");

          if (!this.filteredStats || this.filteredStats.length === 0) {
            alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          // 1. ë°ì´í„° ì¤€ë¹„
          const data = this.filteredStats.map((row) => ({
            ì‚¬ì´íŠ¸: row.site,
            ê²Œì‹œê¸€ìˆ˜: parseInt(row.count) || 0,
            ì²¨ë¶€íŒŒì¼ìˆ˜: parseInt(row.file_count) || 0,
          }));

          // 2. ì›Œí¬ì‹œíŠ¸ ìƒì„±
          const ws = XLSX.utils.json_to_sheet(data);

          // 3. ì—´ ë„ˆë¹„ ì„¤ì •
          ws["!cols"] = [
            { wch: 25 }, // ì‚¬ì´íŠ¸
            { wch: 15 }, // ê²Œì‹œê¸€ìˆ˜
            { wch: 15 }, // ì²¨ë¶€íŒŒì¼ìˆ˜
          ];

          // 4. ì›Œí¬ë¶ ìƒì„±
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "ì‚¬ì´íŠ¸ë³„í†µê³„");

          // 5. íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ í¬í•¨)
          const today = new Date().toISOString().slice(0, 10);
          const filename = `ë²•ê·œë°ì´í„°_ì‚¬ì´íŠ¸ë³„í†µê³„_${today}.xlsx`;

          // 6. íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          XLSX.writeFile(wb, filename);

          console.log("âœ… ì‚¬ì´íŠ¸ë³„ í†µê³„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:", filename);
        } catch (error) {
          console.error("âŒ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:", error);
          alert("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      },

      exportToExcel() {
        try {
          console.log("ğŸ“¥ ìƒì„¸í†µê³„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹œì‘...");

          if (!this.detailStats || this.detailStats.length === 0) {
            alert("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          // 1. ë°ì´í„° ì¤€ë¹„ (ìˆ«ìëŠ” ì‹¤ì œ ê°’ìœ¼ë¡œ, ì²œë‹¨ìœ„ ì½¤ë§ˆ ì œê±°)
          const data = this.detailStats.map((row) => ({
            ì‚¬ì´íŠ¸: row.site,
            í˜ì´ì§€: row.page,
            ê²Œì‹œê¸€ìˆ˜: parseInt(row.posts) || 0,
            ì²¨ë¶€íŒŒì¼ìˆ˜: parseInt(row.files) || 0,
          }));

          // 2. ì›Œí¬ì‹œíŠ¸ ìƒì„±
          const ws = XLSX.utils.json_to_sheet(data);

          // 3. ì—´ ë„ˆë¹„ ì„¤ì •
          ws["!cols"] = [
            { wch: 20 }, // ì‚¬ì´íŠ¸
            { wch: 30 }, // í˜ì´ì§€
            { wch: 12 }, // ê²Œì‹œê¸€ìˆ˜
            { wch: 12 }, // ì²¨ë¶€íŒŒì¼ìˆ˜
          ];

          // 4. ì›Œí¬ë¶ ìƒì„±
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "ì‚¬ì´íŠ¸í˜ì´ì§€ë³„í†µê³„");

          // 5. íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ í¬í•¨)
          const today = new Date().toISOString().slice(0, 10);
          const filename = `ë²•ê·œë°ì´í„°_ìƒì„¸í†µê³„_${today}.xlsx`;

          // 6. íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          XLSX.writeFile(wb, filename);

          console.log("âœ… ìƒì„¸í†µê³„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:", filename);
        } catch (error) {
          console.error("âŒ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:", error);
          alert("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      },
    };
  }
</script>
{% endblock %}
