{% extends "common/base.html" %}

{% block style %}
<style>
  .chart-container {
    @apply bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-6;
  }

  .stat-card {
    @apply bg-white border border-gray-200 rounded-lg p-4 shadow-sm;
  }

  .stat-value {
    @apply text-2xl font-bold text-gray-800;
  }

  .stat-label {
    @apply text-sm text-gray-600 mt-1;
  }

  table {
    @apply w-full border-collapse text-sm;
  }

  thead {
    @apply bg-gray-100;
  }

  th, td {
    @apply border border-gray-300 px-4 py-2 text-left;
  }

  tbody tr:hover {
    @apply bg-blue-50;
  }
</style>
{% endblock %}

{% block content %}
<div x-data="statisticsData()">
  <!-- í˜ì´ì§€ ì œëª© -->
  <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“ˆ í†µê³„ ë¶„ì„</h1>
  <p class="text-gray-600 mb-6">ë²•ê·œê´€ë ¨ ë°ì´í„°ìˆ˜ì§‘ í†µê³„</p>

  <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="bg-white border-b border-gray-200 mb-6">
    <div class="flex gap-4">
      <button
        @click="activeTab = 'chart'"
        :class="activeTab === 'chart' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
        class="px-4 py-3 font-semibold transition-colors"
      >
        ğŸ“ˆ ìˆ˜ì§‘ í†µê³„
      </button>
      <button
        @click="activeTab = 'detail'"
        :class="activeTab === 'detail' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'"
        class="px-4 py-3 font-semibold transition-colors"
      >
        ğŸ¢ ìƒì„¸í†µê³„í‘œ
      </button>
    </div>
  </div>

  <!-- íƒ­ 1: ìˆ˜ì§‘ í†µê³„ -->
  <div x-show="activeTab === 'chart'">
    <!-- ë©”íŠ¸ë¦­ ì¹´ë“œ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ìˆ˜ì§‘ ì‚¬ì´íŠ¸</div>
        <div class="stat-value" x-text="metrics.total_sites || '0'"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ìˆ˜ì§‘ í˜ì´ì§€</div>
        <div class="stat-value" x-text="metrics.total_pages || '0'"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì˜¤ëŠ˜ ìˆ˜ì§‘ í˜ì´ì§€</div>
        <div class="stat-value" x-text="metrics.today_pages || '0'"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ì²¨ë¶€íŒŒì¼ìˆ˜</div>
        <div class="stat-value" x-text="metrics.total_attachments || '0'"></div>
      </div>
    </div>

    <!-- ì°¨íŠ¸ ì˜ì—­ -->
    <div class="chart-container">
      <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š ì‚¬ì´íŠ¸ë³„ ìˆ˜ì§‘ í†µê³„</h2>
      <canvas id="sitesChart" class="max-h-96"></canvas>
    </div>

    <!-- í…Œì´ë¸” -->
    <div class="chart-container">
      <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“‹ ì‚¬ì´íŠ¸ë³„ í†µê³„ í…Œì´ë¸”</h2>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>ì‚¬ì´íŠ¸</th>
              <th>ê²Œì‹œê¸€ìˆ˜</th>
              <th>ì²¨ë¶€íŒŒì¼ìˆ˜</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="row in siteStats" :key="row.site">
              <tr>
                <td x-text="row.site"></td>
                <td x-text="row.count || 0"></td>
                <td x-text="row.file_count || 0"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- íƒ­ 2: ìƒì„¸í†µê³„í‘œ -->
  <div x-show="activeTab === 'detail'">
    <!-- ë©”íŠ¸ë¦­ ì¹´ë“œ (ìƒì„¸í†µê³„) -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ìˆ˜ì§‘ ì‚¬ì´íŠ¸</div>
        <div class="stat-value" x-text="metrics.total_sites || '0'"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ìˆ˜ì§‘ í˜ì´ì§€</div>
        <div class="stat-value" x-text="metrics.total_pages || '0'"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ê²Œì‹œê¸€ìˆ˜</div>
        <div class="stat-value" x-text="metrics.total_pages || '0'"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ì²¨ë¶€íŒŒì¼ìˆ˜</div>
        <div class="stat-value" x-text="metrics.total_attachments || '0'"></div>
      </div>
    </div>

    <!-- ìƒì„¸ í…Œì´ë¸” -->
    <div class="chart-container">
      <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š ì‚¬ì´íŠ¸Â·í˜ì´ì§€ë³„ ê²Œì‹œê¸€ ìˆ˜ ë° ì²¨ë¶€íŒŒì¼ ìˆ˜</h2>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>ì‚¬ì´íŠ¸</th>
              <th>í˜ì´ì§€</th>
              <th>ê²Œì‹œê¸€ìˆ˜</th>
              <th>ì²¨ë¶€íŒŒì¼ìˆ˜</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="row in detailStats" :key="`${row.site}-${row.page}`">
              <tr>
                <td x-text="row.site"></td>
                <td x-text="row.page"></td>
                <td x-text="row.posts || 0"></td>
                <td x-text="row.files || 0"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  function statisticsData() {
    return {
      activeTab: 'chart',
      metrics: {
        total_sites: 0,
        total_pages: 0,
        today_pages: 0,
        total_attachments: 0
      },
      siteStats: [],
      detailStats: [],
      chart: null,

      async init() {
        await this.loadMetrics();
        await this.loadSiteStats();
        await this.loadDetailStats();

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        await this.$nextTick(() => {
          this.initChart();
        });
      },

      async loadMetrics() {
        try {
          const response = await fetch('/api/v1/statistics/metrics');
          if (response.ok) {
            this.metrics = await response.json();
          }
        } catch (error) {
          console.error('ë©”íŠ¸ë¦­ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      },

      async loadSiteStats() {
        try {
          const sitesResponse = await fetch('/api/v1/statistics/sites');
          const filesResponse = await fetch('/api/v1/statistics/files');

          if (sitesResponse.ok && filesResponse.ok) {
            const sites = await sitesResponse.json();
            const files = await filesResponse.json();

            // ë°ì´í„° ë³‘í•©
            this.siteStats = sites.map(s => {
              const fileData = files.find(f => f.site === s.site);
              return {
                ...s,
                file_count: fileData ? fileData.file_count : 0
              };
            });
          }
        } catch (error) {
          console.error('ì‚¬ì´íŠ¸ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      },

      async loadDetailStats() {
        try {
          const response = await fetch('/api/v1/statistics/detail');
          if (response.ok) {
            this.detailStats = await response.json();
          }
        } catch (error) {
          console.error('ìƒì„¸ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      },

      initChart() {
        const canvas = document.getElementById('sitesChart');
        if (!canvas || this.siteStats.length === 0) return;

        const ctx = canvas.getContext('2d');

        const labels = this.siteStats.map(s => s.site);
        const data = this.siteStats.map(s => s.count);

        this.chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'ê²Œì‹œê¸€ìˆ˜',
              data: data,
              backgroundColor: '#3b82f6',
              borderColor: '#1e40af',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 10
                }
              }
            }
          }
        });
      }
    };
  }
</script>
{% endblock %}
